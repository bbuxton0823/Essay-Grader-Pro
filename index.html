<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essay Grader Pro - AI-Powered Assessment Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0d9488;
            --primary-light: #2dd4bf;
            --primary-dark: #0f766e;
            --secondary: #0284c7;
            --secondary-light: #38bdf8;
            --accent: #f59e0b;
            --accent-light: #fbbf24;
            --success: #10b981;
            --success-light: #34d399;
            --warning: #f59e0b;
            --warning-light: #fbbf24;
            --danger: #ef4444;
            --danger-light: #f87171;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --gradient-primary: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
            --gradient-secondary: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-warm: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-hero: linear-gradient(135deg, #134e4a 0%, #0f766e 50%, #0d9488 100%);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-glow: 0 0 20px rgba(13, 148, 136, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            background-attachment: fixed;
            color: var(--gray-900);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background: var(--gradient-primary);
            padding: 1.25rem 0;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
            position: relative;
            z-index: 1;
        }

        .logo {
            font-size: 1.625rem;
            font-weight: 800;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .logo::before {
            content: 'üìù';
            font-size: 1.75rem;
        }

        .logo span {
            color: #fbbf24;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: white;
            background: rgba(255,255,255,0.15);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #f87171;
            box-shadow: 0 0 8px rgba(248, 113, 113, 0.6);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #34d399;
            box-shadow: 0 0 8px rgba(52, 211, 153, 0.6);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-grid {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Teacher Preferences Panel */
        .preferences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .pref-category {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .pref-category::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .pref-category:nth-child(1)::before { background: var(--gradient-primary); }
        .pref-category:nth-child(2)::before { background: var(--gradient-success); }
        .pref-category:nth-child(3)::before { background: var(--gradient-secondary); }
        .pref-category:nth-child(4)::before { background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); }
        .pref-category:nth-child(5)::before { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .pref-category:nth-child(6)::before { background: linear-gradient(135deg, #475569 0%, #334155 100%); }
        .pref-category:nth-child(7)::before { background: var(--gradient-warm); }
        .pref-category:nth-child(8)::before { background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); }
        .pref-category:nth-child(9)::before { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }

        .pref-category:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .pref-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .pref-category-title {
            font-weight: 700;
            font-size: 0.9375rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-800);
        }

        .pref-category-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pref-category-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .pref-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--gray-100);
        }

        .pref-row:last-child {
            border-bottom: none;
        }

        .pref-label {
            font-size: 0.8125rem;
            color: var(--gray-600);
        }

        .pref-input {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .pref-input input[type="number"] {
            width: 65px;
            padding: 0.375rem 0.5rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.8125rem;
            text-align: center;
            font-weight: 600;
            transition: all 0.15s;
        }

        .pref-input input[type="number"]:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        .pref-input input[type="number"]:disabled {
            background: var(--gray-50);
            color: var(--gray-400);
            border-color: var(--gray-100);
        }

        .pref-unit {
            font-size: 0.75rem;
            color: var(--gray-500);
            font-weight: 500;
        }

        .pref-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--gray-200);
            flex-wrap: wrap;
        }

        .pref-actions .btn {
            flex: 1;
            min-width: 120px;
            padding: 0.625rem 1rem;
            font-size: 0.8125rem;
        }

        .preset-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 0.9375rem;
            margin-bottom: 1rem;
            font-weight: 500;
            background: white;
            cursor: pointer;
            transition: all 0.15s;
        }

        .preset-select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        .preset-select:hover {
            border-color: var(--primary-light);
        }

        /* Mode Tabs */
        .mode-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: white;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            padding: 0.5rem;
            box-shadow: var(--shadow);
        }

        .mode-tab {
            flex: 1;
            padding: 0.875rem 1.25rem;
            background: transparent;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--gray-500);
            border-radius: 8px;
            position: relative;
        }

        .mode-tab:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .mode-tab.active {
            color: white;
            background: var(--gradient-primary);
            box-shadow: var(--shadow-md);
        }

        .mode-content {
            display: none;
        }

        .mode-content.active {
            display: block;
        }

        /* Student Progress Styles */
        .progress-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .progress-stat-card {
            background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .progress-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1.2;
        }

        .progress-stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }

        .student-list {
            display: grid;
            gap: 0.75rem;
        }

        .student-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .student-card:hover {
            border-color: var(--primary-light);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .student-card-info {
            flex: 1;
            min-width: 0;
        }

        .student-card-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .student-card-meta {
            font-size: 0.8125rem;
            color: var(--gray-500);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .student-card-scores {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .mini-score {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 700;
        }

        .mini-score-label {
            font-size: 0.5625rem;
            font-weight: 500;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .mini-score.grammar { background: rgba(16, 185, 129, 0.1); color: #059669; }
        .mini-score.spelling { background: rgba(59, 130, 246, 0.1); color: #2563eb; }
        .mini-score.originality { background: rgba(168, 85, 247, 0.1); color: #7c3aed; }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
        }

        .trend-indicator.up { background: rgba(16, 185, 129, 0.1); color: #059669; }
        .trend-indicator.down { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
        .trend-indicator.neutral { background: rgba(107, 114, 128, 0.1); color: #6b7280; }

        /* Student Detail View */
        .student-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .student-detail-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .student-detail-info {
            font-size: 0.875rem;
            color: var(--gray-500);
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .progress-chart-container {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .progress-chart-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--gray-800);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .essay-history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .essay-history-table th {
            background: var(--gray-50);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
        }

        .essay-history-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
        }

        .essay-history-table tr:hover {
            background: var(--gray-50);
        }

        .score-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8125rem;
        }

        .score-badge.high { background: rgba(16, 185, 129, 0.15); color: #059669; }
        .score-badge.medium { background: rgba(245, 158, 11, 0.15); color: #d97706; }
        .score-badge.low { background: rgba(239, 68, 68, 0.15); color: #dc2626; }

        /* Batch Upload Styles */
        .batch-upload-zone {
            border: 2px dashed var(--primary-light);
            border-radius: 16px;
            padding: 2.5rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.02) 0%, rgba(15, 118, 110, 0.02) 100%);
            position: relative;
            overflow: hidden;
        }

        .batch-upload-zone::before {
            content: 'üìö';
            font-size: 3rem;
            display: block;
            margin-bottom: 0.75rem;
            transition: transform 0.3s ease;
        }

        .batch-upload-zone:hover, .batch-upload-zone.dragover {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.05) 0%, rgba(15, 118, 110, 0.05) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .batch-upload-zone:hover::before {
            transform: scale(1.1) rotate(-5deg);
        }

        /* Naming Convention Notice */
        .naming-convention-notice {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .naming-convention-notice code {
            background: rgba(0,0,0,0.05);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8125rem;
        }

        .batch-file-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .batch-file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: var(--gray-50);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .batch-file-item.naming-violation {
            background: #fef2f2;
            border: 1px solid #fecaca;
        }

        .batch-file-item .file-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .batch-file-item .naming-warning {
            font-size: 0.6875rem;
            color: var(--danger);
            background: #fee2e2;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-weight: 500;
        }

        .batch-file-item .remove-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 0.25rem;
        }

        /* Processing Queue */
        .queue-status {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: none;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .queue-status::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--gradient-secondary);
        }

        .queue-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .queue-progress-bar {
            flex: 1;
            height: 12px;
            background: rgba(255,255,255,0.8);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .queue-progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
            border-radius: 6px;
            position: relative;
        }

        .queue-progress-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        .queue-text {
            font-size: 0.875rem;
            color: var(--gray-700);
            font-weight: 500;
        }

        /* Batch Results Stream */
        .batch-results-container {
            display: none;
        }

        .batch-results-container.visible {
            display: block;
        }

        .class-summary {
            background: var(--gradient-secondary);
            border: none;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .class-summary::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        .class-summary h3 {
            margin-bottom: 1rem;
            color: white;
            font-size: 1.125rem;
            position: relative;
            z-index: 1;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            position: relative;
            z-index: 1;
        }

        .summary-stat {
            text-align: center;
            padding: 1rem 0.75rem;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }

        .summary-stat:hover {
            transform: translateY(-2px);
        }

        .summary-stat .stat-value {
            font-size: 1.75rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .summary-stat .stat-label {
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
            font-weight: 500;
        }

        /* Individual Essay Result Cards */
        .essay-results-stream {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .essay-result-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
        }

        .essay-result-card:hover {
            box-shadow: var(--shadow-md);
        }

        .essay-result-card.processing {
            opacity: 0.7;
            background: repeating-linear-gradient(
                -45deg,
                white,
                white 10px,
                var(--gray-50) 10px,
                var(--gray-50) 20px
            );
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 0 0; }
            100% { background-position: 40px 0; }
        }

        .essay-result-card.error {
            border-color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .essay-result-card.naming-penalty {
            border-left: 4px solid var(--warning);
        }

        .naming-penalty-badge {
            font-size: 0.6875rem;
            color: white;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            padding: 0.25rem 0.625rem;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
        }

        .essay-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            transition: background 0.15s;
        }

        .essay-card-header:hover {
            background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-50) 100%);
        }

        .essay-card-student {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .essay-card-student .student-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .essay-card-student .student-meta {
            font-size: 0.8125rem;
            color: var(--gray-500);
        }

        .essay-card-scores {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .mini-score {
            text-align: center;
            min-width: 50px;
        }

        .mini-score .score-num {
            font-weight: 700;
            font-size: 1.125rem;
        }

        .mini-score .score-num.high { color: var(--success); }
        .mini-score .score-num.medium { color: var(--warning); }
        .mini-score .score-num.low { color: var(--danger); }

        .mini-score .score-cat {
            font-size: 0.625rem;
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .ai-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .ai-indicator.low { background: #d1fae5; color: #065f46; }
        .ai-indicator.medium { background: #fef3c7; color: #92400e; }
        .ai-indicator.high { background: #fee2e2; color: #991b1b; }

        .essay-card-toggle {
            color: var(--gray-400);
            transition: transform 0.2s;
        }

        .essay-card-header.expanded .essay-card-toggle {
            transform: rotate(180deg);
        }

        .essay-card-body {
            display: none;
            padding: 1.25rem;
        }

        .essay-card-body.expanded {
            display: block;
        }

        .essay-card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            flex-wrap: wrap;
        }

        /* Temperature Slider */
        .temperature-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .temperature-control label {
            margin-bottom: 0;
            white-space: nowrap;
            font-weight: 600;
            color: var(--gray-700);
        }

        .temperature-control input[type="range"] {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, var(--success) 0%, var(--warning) 50%, var(--danger) 100%);
            border-radius: 4px;
            padding: 0;
        }

        .temperature-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: white;
            border: 3px solid var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.15s;
        }

        .temperature-control input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }

        .temperature-value {
            min-width: 50px;
            text-align: center;
            font-weight: 700;
            font-size: 1.125rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Collapsible sections */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .collapsible-header .toggle-icon {
            font-size: 1.25rem;
            transition: transform 0.2s;
        }

        .collapsible-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0 !important;
            padding-top: 0;
            padding-bottom: 0;
        }

        .card {
            background: white;
            border-radius: 16px;
            border: 1px solid var(--gray-200);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        input[type="text"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 0.9375rem;
            transition: all 0.2s ease;
            background: white;
        }

        input:hover,
        select:hover,
        textarea:hover {
            border-color: var(--gray-300);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.1);
        }

        textarea {
            min-height: 200px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.7;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 0.9375rem;
            font-weight: 600;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(13, 148, 136, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13, 148, 136, 0.5);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            background: var(--gray-300);
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 2px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--primary-light);
            color: var(--primary);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }

        .btn-warning {
            background: var(--gradient-warm);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(245, 158, 11, 0.4);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
        }

        .file-upload {
            border: 2px dashed var(--gray-300);
            border-radius: 16px;
            padding: 2.5rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
            position: relative;
            overflow: hidden;
        }

        .file-upload::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.25s;
        }

        .file-upload:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .file-upload:hover::before {
            opacity: 0.03;
        }

        .file-upload input {
            display: none;
        }

        .file-upload-icon {
            font-size: 3rem;
            margin-bottom: 0.75rem;
            display: block;
            filter: grayscale(0);
            transition: transform 0.3s;
        }

        .file-upload:hover .file-upload-icon {
            transform: scale(1.1);
        }

        .file-upload-text {
            color: var(--gray-600);
            font-size: 0.9375rem;
        }

        .file-upload-text strong {
            color: var(--primary);
        }

        .file-name {
            margin-top: 0.75rem;
            font-weight: 600;
            color: var(--primary);
            background: rgba(13, 148, 136, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            display: inline-block;
        }

        .input-row {
            display: flex;
            gap: 1rem;
        }

        .input-row .form-group {
            flex: 1;
        }

        .api-config {
            margin-bottom: 2rem;
            border-left: 4px solid var(--primary-light);
        }

        .api-config .card-title::before {
            content: 'üîê';
            margin-right: 0.5rem;
        }

        .api-row {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .api-row .form-group:first-child {
            flex: 2;
        }

        .api-row .form-group:nth-child(2) {
            flex: 1;
        }

        .password-toggle {
            position: relative;
        }

        .password-toggle input {
            padding-right: 2.5rem;
        }

        .toggle-btn {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-500);
            padding: 0.25rem;
        }

        .results-section {
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .score-grid.four-cols {
            grid-template-columns: repeat(4, 1fr);
        }

        @media (max-width: 768px) {
            .score-grid.four-cols {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .score-grid {
                grid-template-columns: 1fr;
            }
            .score-grid.four-cols {
                grid-template-columns: 1fr;
            }
        }

        .toggle-option {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            padding: 1rem 1.25rem;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .toggle-option:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .toggle-option.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.05) 0%, rgba(15, 118, 110, 0.05) 100%);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            background: var(--gray-300);
            border-radius: 13px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-option.active .toggle-switch {
            background: var(--gradient-primary);
        }

        .toggle-option.active .toggle-switch::after {
            transform: translateX(22px);
        }

        .toggle-label {
            flex: 1;
        }

        .toggle-title {
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--gray-800);
        }

        .toggle-desc {
            font-size: 0.8125rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .ap-badge {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            font-size: 0.6875rem;
            font-weight: 700;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(30, 64, 175, 0.3);
        }

        .score-card {
            background: white;
            border-radius: 16px;
            padding: 1.25rem;
            text-align: center;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow);
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .score-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gray-200);
        }

        .score-card.high::before {
            background: var(--gradient-success);
        }

        .score-card.medium::before {
            background: var(--gradient-warm);
        }

        .score-card.low::before {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .score-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .score-label {
            font-size: 0.8125rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .score-value {
            font-size: 2.5rem;
            font-weight: 800;
        }

        .score-value.high {
            background: var(--gradient-success);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-value.medium {
            background: var(--gradient-warm);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-value.low {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .progress-bar {
            height: 10px;
            background: var(--gray-100);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 0.75rem;
        }

        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-fill.high {
            background: var(--gradient-success);
        }

        .progress-fill.medium {
            background: var(--gradient-warm);
        }

        .progress-fill.low {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .ai-alert {
            display: none;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .ai-alert.visible {
            display: flex;
        }

        .ai-alert.warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
        }

        .ai-alert.danger {
            background: #fee2e2;
            border: 1px solid var(--danger);
        }

        .ai-alert.safe {
            background: #d1fae5;
            border: 1px solid var(--success);
        }

        .ai-alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .ai-alert-content {
            flex: 1;
        }

        .ai-alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .ai-alert-text {
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .feedback-section {
            margin-top: 1.5rem;
        }

        .feedback-category {
            margin-bottom: 1.5rem;
        }

        .feedback-header {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-list {
            list-style: none;
            padding-left: 1.5rem;
        }

        .feedback-list li {
            position: relative;
            margin-bottom: 0.5rem;
            font-size: 0.9375rem;
            color: var(--gray-700);
        }

        .feedback-list li::before {
            content: "‚Ä¢";
            position: absolute;
            left: -1rem;
            color: var(--gray-400);
        }

        .overall-feedback {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1.5rem;
        }

        .overall-feedback h4 {
            margin-bottom: 0.5rem;
        }

        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 2rem;
            color: var(--gray-500);
        }

        .loading.visible {
            display: flex;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-message {
            display: none;
            background: #fee2e2;
            border: 1px solid var(--danger);
            border-radius: 8px;
            padding: 1rem;
            color: var(--danger);
            margin-bottom: 1rem;
        }

        .error-message.visible {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .tab {
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            font-size: 0.9375rem;
            color: var(--gray-500);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.15s;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .help-text {
            font-size: 0.8125rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .char-count {
            text-align: right;
            font-size: 0.8125rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .remember-key {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .remember-key input {
            width: auto;
        }

        /* Redlined Essay Styles - Traditional Teacher Markup */
        .highlighted-essay-section {
            margin-top: 1.5rem;
            border-top: 1px solid var(--gray-200);
            padding-top: 1.5rem;
        }

        .highlighted-essay-container {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1.5rem;
            font-family: 'Georgia', serif;
            font-size: 1rem;
            line-height: 2.2;
            max-height: 500px;
            overflow-y: auto;
            min-height: 200px;
        }

        .highlighted-essay-container[contenteditable="true"] {
            border: 2px solid var(--primary);
            outline: none;
        }

        .highlighted-essay-container[contenteditable="true"]:focus {
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        /* Editor toolbar */
        .editor-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: var(--gray-100);
            border-radius: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        .editor-toolbar .toolbar-group {
            display: flex;
            gap: 0.25rem;
            padding-right: 0.75rem;
            border-right: 1px solid var(--gray-300);
        }

        .editor-toolbar .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            padding: 0.375rem 0.625rem;
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8125rem;
            transition: all 0.15s;
        }

        .toolbar-btn:hover {
            background: var(--gray-50);
            border-color: var(--primary);
        }

        .toolbar-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .toolbar-btn.danger {
            color: var(--danger);
        }

        .toolbar-btn.danger:hover {
            background: #fee2e2;
            border-color: var(--danger);
        }

        .edit-mode-indicator {
            font-size: 0.75rem;
            color: var(--primary);
            font-weight: 500;
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .edit-mode-indicator::before {
            content: '‚úèÔ∏è';
        }

        /* Redline markup - strikethrough with correction */
        .redline-error {
            position: relative;
            display: inline;
        }

        .redline-original {
            color: #dc2626;
            text-decoration: line-through;
            text-decoration-color: #dc2626;
            text-decoration-thickness: 2px;
        }

        .redline-correction {
            color: #dc2626;
            font-weight: 600;
            margin-left: 2px;
            position: relative;
        }

        .redline-correction::before {
            content: '[';
            color: #dc2626;
        }

        .redline-correction::after {
            content: ']';
            color: #dc2626;
        }

        /* Different marker styles for error types */
        .redline-spelling .redline-original {
            text-decoration-style: wavy;
        }

        .redline-grammar .redline-original {
            text-decoration-style: solid;
        }

        .redline-ap .redline-original {
            text-decoration-style: double;
        }

        /* Margin comments for context */
        .margin-comment {
            display: inline-block;
            background: #fef3c7;
            border-left: 3px solid #dc2626;
            padding: 2px 6px;
            margin-left: 8px;
            font-size: 0.75rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #92400e;
            vertical-align: super;
            border-radius: 2px;
        }

        .error-legend {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8125rem;
        }

        .legend-sample {
            font-family: 'Georgia', serif;
            font-size: 0.875rem;
        }

        .legend-sample .redline-original {
            font-size: 0.875rem;
        }

        .legend-sample .redline-correction {
            font-size: 0.75rem;
        }

        /* Caret insertion mark for missing text */
        .redline-insert {
            color: #dc2626;
            font-weight: 600;
        }

        .redline-insert::before {
            content: '^';
            position: relative;
            top: 2px;
            margin-right: 1px;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                font-size: 11pt;
            }

            header, .api-config, .left-column, .btn, .tabs, .tab-content {
                display: none !important;
            }

            .main-grid {
                display: block;
            }

            .card {
                border: none;
                padding: 0;
            }

            .results-section {
                display: block !important;
            }

            .highlighted-essay-container {
                max-height: none;
                overflow: visible;
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }

            .score-grid {
                margin-bottom: 1rem;
            }

            .score-card {
                padding: 0.5rem;
            }

            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid #333;
            }

            .print-header h1 {
                font-size: 18pt;
                margin-bottom: 0.5rem;
            }

            .print-header .meta {
                font-size: 10pt;
                color: #666;
            }

            /* Ensure redline markup prints clearly */
            .redline-original {
                color: #dc2626 !important;
                text-decoration: line-through !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .redline-correction {
                color: #dc2626 !important;
                font-weight: bold !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .error-legend {
                background: #f5f5f5 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        .print-header {
            display: none;
        }

        /* Tooltip styles */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 100;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                <div class="logo">Essay<span>Grader</span> Pro</div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.8); display: flex; align-items: center; gap: 0.5rem;">
                    <span style="background: rgba(255,255,255,0.2); padding: 0.125rem 0.5rem; border-radius: 4px; font-weight: 600;">üìä i-Ready</span>
                    <span>Writing Assessment Standards ‚Ä¢ Grades 6-12</span>
                </div>
            </div>
            <div class="api-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">API Not Connected</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-grid">
            <!-- API Configuration - Collapsible (collapsed by default) -->
            <div class="card api-config">
                <div class="collapsible-header collapsed" onclick="toggleSection('apiSection', this)">
                    <h2 class="card-title" style="margin-bottom: 0;">‚öôÔ∏è API Configuration</h2>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="collapsible-content collapsed" id="apiSection" style="margin-top: 1rem;">
                    <div class="api-row">
                        <div class="form-group">
                            <label for="apiKey">API Key</label>
                            <div class="password-toggle">
                                <input type="password" id="apiKey" placeholder="Enter your API key">
                                <button type="button" class="toggle-btn" onclick="togglePassword()">üëÅÔ∏è</button>
                            </div>
                            <div class="help-text">Your key is stored locally and sent directly to the API provider.</div>
                        </div>
                        <div class="form-group">
                            <label for="apiProvider">Provider</label>
                            <select id="apiProvider">
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="openai">OpenAI (GPT)</option>
                            </select>
                        </div>
                    </div>
                    <div class="remember-key">
                        <input type="checkbox" id="rememberKey">
                        <label for="rememberKey" style="margin-bottom: 0;">Remember API key in browser</label>
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="testConnection()">Test Connection</button>
                </div>
            </div>

            <!-- Teacher Preferences - Collapsible -->
            <div class="card api-config">
                <div class="collapsible-header collapsed" onclick="toggleSection('preferencesSection', this)">
                    <h2 class="card-title" style="margin-bottom: 0;">üéì Teacher Preferences</h2>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="collapsible-content collapsed" id="preferencesSection" style="margin-top: 1rem;">
                    <p style="color: var(--gray-500); font-size: 0.875rem; margin-bottom: 1rem;">
                        Customize grading criteria, penalties, and score weights to match your classroom standards.
                    </p>

                    <!-- Preset Selection -->
                    <div style="margin-bottom: 1rem;">
                        <label style="font-size: 0.875rem; font-weight: 500;">Quick Presets:</label>
                        <select class="preset-select" id="presetSelect" onchange="loadPreset(this.value)">
                            <option value="default">Default (Balanced)</option>
                            <option value="strict">Strict Grading</option>
                            <option value="lenient">Lenient Grading</option>
                            <option value="grammar-focus">Grammar Focus</option>
                            <option value="originality-focus">Originality Focus</option>
                            <option value="no-penalties">No Penalties</option>
                        </select>
                    </div>

                    <div class="preferences-grid">
                        <!-- Naming Convention -->
                        <div class="pref-category">
                            <div class="pref-category-header">
                                <span class="pref-category-title">üìã Naming Convention</span>
                                <div class="pref-category-toggle">
                                    <label style="font-size: 0.75rem;">Enable</label>
                                    <input type="checkbox" id="prefNamingEnabled" checked onchange="updatePreference('naming', 'enabled', this.checked)">
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Required pattern</span>
                                <div class="pref-input" style="flex: 1;">
                                    <select id="prefNamingPattern" style="width: 100%; padding: 0.375rem 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 0.875rem;" onchange="updatePreference('naming', 'pattern', this.value); updateNamingPatternDisplay();">
                                        <option value="firstname_lastname_assignment">FirstName_LastName_Assignment</option>
                                        <option value="lastname_firstname_assignment">LastName_FirstName_Assignment</option>
                                        <option value="studentid_assignment">StudentID_Assignment</option>
                                        <option value="lastname_assignment">LastName_Assignment</option>
                                        <option value="firstname_lastname">FirstName_LastName</option>
                                        <option value="any_underscore">Any Underscore-Separated</option>
                                    </select>
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Penalty for wrong format</span>
                                <div class="pref-input">
                                    <input type="number" id="prefNamingPenalty" value="10" min="0" max="50" onchange="updatePreference('naming', 'penalty', this.value)">
                                    <span class="pref-unit">pts</span>
                                </div>
                            </div>
                            <div id="namingPatternExample" style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem;">
                                Example: John_Smith_NarrativeEssay.docx
                            </div>
                        </div>

                        <!-- Grammar Settings -->
                        <div class="pref-category">
                            <div class="pref-category-header">
                                <span class="pref-category-title">‚úèÔ∏è Grammar</span>
                                <div class="pref-category-toggle">
                                    <label style="font-size: 0.75rem;">Enable</label>
                                    <input type="checkbox" id="prefGrammarEnabled" checked onchange="updatePreference('grammar', 'enabled', this.checked)">
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Weight in final score</span>
                                <div class="pref-input">
                                    <input type="number" id="prefGrammarWeight" value="30" min="0" max="100" onchange="updatePreference('grammar', 'weight', this.value)">
                                    <span class="pref-unit">%</span>
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Min passing score</span>
                                <div class="pref-input">
                                    <input type="number" id="prefGrammarMinPass" value="60" min="0" max="100" onchange="updatePreference('grammar', 'minPass', this.value)">
                                    <span class="pref-unit">%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Spelling Settings -->
                        <div class="pref-category">
                            <div class="pref-category-header">
                                <span class="pref-category-title">üî§ Spelling</span>
                                <div class="pref-category-toggle">
                                    <label style="font-size: 0.75rem;">Enable</label>
                                    <input type="checkbox" id="prefSpellingEnabled" checked onchange="updatePreference('spelling', 'enabled', this.checked)">
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Weight in final score</span>
                                <div class="pref-input">
                                    <input type="number" id="prefSpellingWeight" value="20" min="0" max="100" onchange="updatePreference('spelling', 'weight', this.value)">
                                    <span class="pref-unit">%</span>
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Min passing score</span>
                                <div class="pref-input">
                                    <input type="number" id="prefSpellingMinPass" value="60" min="0" max="100" onchange="updatePreference('spelling', 'minPass', this.value)">
                                    <span class="pref-unit">%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Originality Settings -->
                        <div class="pref-category">
                            <div class="pref-category-header">
                                <span class="pref-category-title">üí° Originality</span>
                                <div class="pref-category-toggle">
                                    <label style="font-size: 0.75rem;">Enable</label>
                                    <input type="checkbox" id="prefOriginalityEnabled" checked onchange="updatePreference('originality', 'enabled', this.checked)">
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Weight in final score</span>
                                <div class="pref-input">
                                    <input type="number" id="prefOriginalityWeight" value="30" min="0" max="100" onchange="updatePreference('originality', 'weight', this.value)">
                                    <span class="pref-unit">%</span>
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Min passing score</span>
                                <div class="pref-input">
                                    <input type="number" id="prefOriginalityMinPass" value="50" min="0" max="100" onchange="updatePreference('originality', 'minPass', this.value)">
                                    <span class="pref-unit">%</span>
                                </div>
                            </div>
                        </div>

                        <!-- AP Style Settings -->
                        <div class="pref-category">
                            <div class="pref-category-header">
                                <span class="pref-category-title">üì∞ AP Style</span>
                                <div class="pref-category-toggle">
                                    <label style="font-size: 0.75rem;">Enable</label>
                                    <input type="checkbox" id="prefAPStyleEnabled" onchange="updatePreference('apStyle', 'enabled', this.checked)">
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Weight in final score</span>
                                <div class="pref-input">
                                    <input type="number" id="prefAPStyleWeight" value="20" min="0" max="100" onchange="updatePreference('apStyle', 'weight', this.value)">
                                    <span class="pref-unit">%</span>
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Min passing score</span>
                                <div class="pref-input">
                                    <input type="number" id="prefAPStyleMinPass" value="60" min="0" max="100" onchange="updatePreference('apStyle', 'minPass', this.value)">
                                    <span class="pref-unit">%</span>
                                </div>
                            </div>
                        </div>

                        <!-- AI Detection Settings -->
                        <div class="pref-category">
                            <div class="pref-category-header">
                                <span class="pref-category-title">ü§ñ AI Detection</span>
                                <div class="pref-category-toggle">
                                    <label style="font-size: 0.75rem;">Enable</label>
                                    <input type="checkbox" id="prefAIDetectionEnabled" checked onchange="updatePreference('aiDetection', 'enabled', this.checked)">
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Penalty for HIGH AI likelihood</span>
                                <div class="pref-input">
                                    <input type="number" id="prefAIHighPenalty" value="0" min="0" max="100" onchange="updatePreference('aiDetection', 'highPenalty', this.value)">
                                    <span class="pref-unit">pts</span>
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Penalty for MEDIUM AI likelihood</span>
                                <div class="pref-input">
                                    <input type="number" id="prefAIMediumPenalty" value="0" min="0" max="100" onchange="updatePreference('aiDetection', 'mediumPenalty', this.value)">
                                    <span class="pref-unit">pts</span>
                                </div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem;">
                                Set to 0 for flagging only (no point deduction)
                            </div>
                        </div>

                        <!-- Late Submission -->
                        <div class="pref-category">
                            <div class="pref-category-header">
                                <span class="pref-category-title">‚è∞ Late Submission</span>
                                <div class="pref-category-toggle">
                                    <label style="font-size: 0.75rem;">Enable</label>
                                    <input type="checkbox" id="prefLateEnabled" onchange="updatePreference('late', 'enabled', this.checked)">
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Penalty per day late</span>
                                <div class="pref-input">
                                    <input type="number" id="prefLatePenaltyPerDay" value="5" min="0" max="50" onchange="updatePreference('late', 'penaltyPerDay', this.value)">
                                    <span class="pref-unit">pts/day</span>
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Maximum penalty</span>
                                <div class="pref-input">
                                    <input type="number" id="prefLateMaxPenalty" value="30" min="0" max="100" onchange="updatePreference('late', 'maxPenalty', this.value)">
                                    <span class="pref-unit">pts</span>
                                </div>
                            </div>
                        </div>

                        <!-- Word Count -->
                        <div class="pref-category">
                            <div class="pref-category-header">
                                <span class="pref-category-title">üìè Word Count</span>
                                <div class="pref-category-toggle">
                                    <label style="font-size: 0.75rem;">Enable</label>
                                    <input type="checkbox" id="prefWordCountEnabled" onchange="updatePreference('wordCount', 'enabled', this.checked)">
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Minimum words required</span>
                                <div class="pref-input">
                                    <input type="number" id="prefWordCountMin" value="250" min="0" max="5000" onchange="updatePreference('wordCount', 'min', this.value)">
                                    <span class="pref-unit">words</span>
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Penalty if under minimum</span>
                                <div class="pref-input">
                                    <input type="number" id="prefWordCountPenalty" value="10" min="0" max="50" onchange="updatePreference('wordCount', 'penalty', this.value)">
                                    <span class="pref-unit">pts</span>
                                </div>
                            </div>
                        </div>

                        <!-- Grade Level Override -->
                        <div class="pref-category">
                            <div class="pref-category-header">
                                <span class="pref-category-title">üéØ Grade Level (i-Ready)</span>
                                <div class="pref-category-toggle">
                                    <label style="font-size: 0.75rem;">Override</label>
                                    <input type="checkbox" id="prefGradeLevelOverride" onchange="updatePreference('gradeLevel', 'override', this.checked)">
                                </div>
                            </div>
                            <div class="pref-row">
                                <span class="pref-label">Force grade level</span>
                                <div class="pref-input" style="width: auto;">
                                    <select id="prefGradeLevelValue" style="padding: 0.375rem; border: 1px solid var(--gray-300); border-radius: 4px; font-size: 0.875rem;" onchange="updatePreference('gradeLevel', 'value', this.value)">
                                        <option value="6">6th Grade</option>
                                        <option value="7">7th Grade</option>
                                        <option value="8">8th Grade</option>
                                        <option value="9">9th Grade</option>
                                        <option value="10">10th Grade</option>
                                        <option value="11">11th Grade</option>
                                        <option value="12">12th Grade</option>
                                    </select>
                                </div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem;">
                                <strong style="color: var(--primary);">üìä i-Ready Assessment:</strong> By default, writing level is auto-detected using i-Ready Reading & Writing benchmarks. Enable override to force a specific grade level.
                            </div>
                        </div>
                    </div>

                    <div class="pref-actions">
                        <button class="btn btn-secondary" onclick="resetPreferences()">‚Ü∫ Reset to Default</button>
                        <button class="btn btn-secondary" onclick="exportPreferences()">üì§ Export Settings</button>
                        <button class="btn btn-secondary" onclick="importPreferences()">üì• Import Settings</button>
                        <button class="btn btn-primary" onclick="savePreferences()">üíæ Save Preferences</button>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem; text-align: center;">
                        Preferences are saved in your browser and persist between sessions.
                    </div>
                </div>
            </div>

            <!-- Mode Selection Tabs -->
            <div class="mode-tabs">
                <button class="mode-tab active" onclick="switchMode('single')">üìù Single Essay</button>
                <button class="mode-tab" onclick="switchMode('batch')">üìö Batch Grading</button>
                <button class="mode-tab" onclick="switchMode('progress')">üìà Student Progress</button>
            </div>

            <!-- SINGLE ESSAY MODE -->
            <div id="singleMode" class="mode-content active">
                <!-- Essay Input -->
                <div class="card">
                    <h2 class="card-title">üìù Essay Input</h2>

                <div class="form-group">
                    <label for="studentName">Student Name</label>
                    <input type="text" id="studentName" placeholder="Enter student name or upload file to auto-detect">
                </div>

                <!-- AP Style Toggle -->
                <div class="toggle-option" id="apStyleToggle" onclick="toggleAPStyle()">
                    <div class="toggle-switch"></div>
                    <div class="toggle-label">
                        <div class="toggle-title">Check AP Style Format <span class="ap-badge">AP</span></div>
                        <div class="toggle-desc">Evaluate essay against Associated Press style guidelines</div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab('paste')">Paste Text</button>
                    <button class="tab" onclick="switchTab('upload')">Upload File</button>
                </div>

                <div id="pasteTab" class="tab-content active">
                    <div class="form-group">
                        <textarea id="essayText" placeholder="Paste the student's essay here..." oninput="updateCharCount()" style="min-height: 150px;"></textarea>
                        <div class="char-count"><span id="charCount">0</span> characters | <span id="wordCount">0</span> words</div>
                    </div>
                </div>

                <div id="uploadTab" class="tab-content">
                    <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" accept=".txt,.docx,.pdf" onchange="handleFileUpload(event)">
                        <div class="file-upload-icon">üìÑ</div>
                        <div class="file-upload-text">Click to upload .txt, .docx, or .pdf files</div>
                        <div class="file-name" id="fileName"></div>
                    </div>
                </div>

                <div class="error-message" id="errorMessage"></div>

                <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="gradeEssay()" id="gradeBtn">
                    <span>‚ú®</span> Grade Essay
                </button>
            </div>

            <!-- Results Section -->
            <div class="card" id="resultsCard" style="display: none;">
                <h2 class="card-title">üìä Assessment Results</h2>

                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <span>Analyzing essay...</span>
                    </div>

                    <div class="results-section" id="results">
                        <!-- Print Header (only visible when printing) -->
                        <div class="print-header">
                            <h1>Essay Assessment Report</h1>
                            <div class="meta" id="printMeta"></div>
                        </div>

                        <div id="studentHeader" style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--gray-200);">
                            <strong id="resultStudentName"></strong>
                            <span id="resultMeta" style="color: var(--gray-500); font-size: 0.875rem;"></span>
                        </div>

                        <!-- Auto-Detected Info (i-Ready Assessment) -->
                        <div class="detected-info" id="detectedInfo" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #f0f9ff 0%, #ecfdf5 100%); border: 1px solid #0d9488; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="background: var(--primary); color: white; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.6875rem; font-weight: 600;">üìä i-Ready Assessment</span>
                            </div>
                            <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; font-size: 0.875rem;">
                                <div><strong>Writing Level:</strong> <span id="detectedGradeLevel" style="font-weight: 600; color: #0d9488;">-</span></div>
                                <div><strong>Essay Type:</strong> <span id="detectedType">-</span></div>
                                <div><strong>Tone:</strong> <span id="detectedTone">-</span></div>
                            </div>
                            <div id="gradeLevelReasoning" style="display: none; margin-top: 0.5rem; font-size: 0.8125rem; color: var(--gray-600); font-style: italic;"></div>
                        </div>

                        <!-- AI Detection Alert -->
                        <div class="ai-alert" id="aiAlert">
                            <div class="ai-alert-icon" id="aiAlertIcon">‚ö†Ô∏è</div>
                            <div class="ai-alert-content">
                                <div class="ai-alert-title" id="aiAlertTitle">AI Detection</div>
                                <div class="ai-alert-text" id="aiAlertText"></div>
                                <div class="ai-red-flags" id="aiRedFlags" style="display: none; margin-top: 0.75rem;">
                                    <div style="font-weight: 600; color: #991b1b; margin-bottom: 0.25rem;">üö© Red Flags Detected:</div>
                                    <ul id="redFlagsList" style="margin: 0; padding-left: 1.25rem; font-size: 0.8125rem;"></ul>
                                </div>
                                <div class="ai-excerpts" id="aiExcerpts" style="display: none; margin-top: 0.75rem;">
                                    <div style="font-weight: 600; color: #991b1b; margin-bottom: 0.25rem;">üìù Suspicious Excerpts:</div>
                                    <ul id="excerptsList" style="margin: 0; padding-left: 1.25rem; font-size: 0.8125rem; font-style: italic;"></ul>
                                </div>
                            </div>
                        </div>

                        <!-- Scores -->
                        <div class="score-grid" id="scoreGrid">
                            <div class="score-card">
                                <div class="score-label">Grammar</div>
                                <div class="score-value" id="grammarScore">--%</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="grammarProgress" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="score-card">
                                <div class="score-label">Spelling</div>
                                <div class="score-value" id="spellingScore">--%</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="spellingProgress" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="score-card">
                                <div class="score-label">Originality</div>
                                <div class="score-value" id="originalityScore">--%</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="originalityProgress" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="score-card" id="apScoreCard" style="display: none;">
                                <div class="score-label">AP Style <span class="ap-badge" style="font-size: 0.5rem;">AP</span></div>
                                <div class="score-value" id="apStyleScore">--%</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="apStyleProgress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Feedback -->
                        <div class="feedback-section">
                            <div class="feedback-category">
                                <div class="feedback-header">üìñ Grammar Feedback</div>
                                <ul class="feedback-list" id="grammarFeedback"></ul>
                            </div>
                            <div class="feedback-category">
                                <div class="feedback-header">‚úèÔ∏è Spelling Feedback</div>
                                <ul class="feedback-list" id="spellingFeedback"></ul>
                            </div>
                            <div class="feedback-category">
                                <div class="feedback-header">üí° Originality Feedback</div>
                                <ul class="feedback-list" id="originalityFeedback"></ul>
                            </div>
                            <div class="feedback-category" id="apFeedbackSection" style="display: none;">
                                <div class="feedback-header">üì∞ AP Style Feedback <span class="ap-badge">AP</span></div>
                                <ul class="feedback-list" id="apStyleFeedback"></ul>
                            </div>
                        </div>

                        <!-- Redlined Essay Section -->
                        <div class="highlighted-essay-section" id="highlightedSection">
                            <div class="feedback-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>üìÑ Redlined Essay (Teacher Markup)</span>
                                <button class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.8125rem;" onclick="toggleEditMode()">
                                    <span id="editModeBtn">‚úèÔ∏è Enable Editing</span>
                                </button>
                            </div>
                            <div class="error-legend">
                                <div class="legend-item">
                                    <span class="legend-sample"><span class="redline-error redline-spelling"><span class="redline-original">teh</span><span class="redline-correction">the</span></span></span>
                                    <span>= Spelling (wavy)</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-sample"><span class="redline-error redline-grammar"><span class="redline-original">was went</span><span class="redline-correction">went</span></span></span>
                                    <span>= Grammar (solid)</span>
                                </div>
                                <div class="legend-item" id="apLegend" style="display: none;">
                                    <span class="legend-sample"><span class="redline-error redline-ap"><span class="redline-original">10 people</span><span class="redline-correction">ten people</span></span></span>
                                    <span>= AP Style (double)</span>
                                </div>
                            </div>
                            <!-- Editor Toolbar (hidden by default) -->
                            <div class="editor-toolbar" id="editorToolbar" style="display: none;">
                                <div class="toolbar-group">
                                    <button class="toolbar-btn" onclick="markAsSpelling()" title="Mark selection as spelling error">
                                        üî§ Spelling
                                    </button>
                                    <button class="toolbar-btn" onclick="markAsGrammar()" title="Mark selection as grammar error">
                                        üìù Grammar
                                    </button>
                                    <button class="toolbar-btn" onclick="markAsAP()" title="Mark selection as AP style error" id="apToolbarBtn" style="display: none;">
                                        üì∞ AP Style
                                    </button>
                                </div>
                                <div class="toolbar-group">
                                    <button class="toolbar-btn" onclick="addComment()" title="Add margin comment">
                                        üí¨ Comment
                                    </button>
                                    <button class="toolbar-btn danger" onclick="clearMarkup()" title="Remove formatting from selection">
                                        ‚úñÔ∏è Clear
                                    </button>
                                </div>
                                <div class="edit-mode-indicator">Edit Mode Active</div>
                            </div>
                            <div class="highlighted-essay-container" id="highlightedEssay"></div>
                        </div>

                        <!-- Overall Assessment -->
                        <div class="overall-feedback">
                            <h4>üìã Overall Assessment</h4>
                            <p id="overallFeedback"></p>
                        </div>

                        <!-- Strengths and Areas for Improvement -->
                        <div class="overall-feedback" style="margin-top: 1rem;">
                            <h4>‚úÖ What You Did Well</h4>
                            <ul class="feedback-list" id="strengthsFeedback"></ul>
                        </div>
                        <div class="overall-feedback" style="margin-top: 1rem;">
                            <h4>üéØ Areas to Improve</h4>
                            <ul class="feedback-list" id="improvementFeedback"></ul>
                        </div>

                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Print Report</button>
                            <button class="btn btn-secondary" onclick="copyHighlightedEssay()">üìã Copy Marked Essay</button>
                        </div>
                    </div>

                    <div id="placeholder" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                        <p>Enter an essay and click "Grade Essay" to see the assessment results.</p>
                    </div>
                </div>
            </div>
            </div><!-- End Single Mode -->

            <!-- BATCH GRADING MODE -->
            <div id="batchMode" class="mode-content">
                <div class="card">
                    <h2 class="card-title">üìö Batch Essay Grading</h2>
                    <p style="color: var(--gray-500); margin-bottom: 1rem;">Upload multiple essays to grade them all at once. Each essay will be processed individually for maximum accuracy.</p>

                    <!-- AP Style Toggle for Batch -->
                    <div class="toggle-option" id="batchApStyleToggle" onclick="toggleBatchAPStyle()">
                        <div class="toggle-switch"></div>
                        <div class="toggle-label">
                            <div class="toggle-title">Check AP Style Format <span class="ap-badge">AP</span></div>
                            <div class="toggle-desc">Evaluate all essays against AP style guidelines</div>
                        </div>
                    </div>

                    <!-- Temperature Control -->
                    <div class="temperature-control">
                        <label for="temperatureSlider">üéØ Consistency:</label>
                        <input type="range" id="temperatureSlider" min="0" max="1" step="0.1" value="0.3" oninput="updateTemperatureDisplay()">
                        <span class="temperature-value" id="temperatureValue">0.3</span>
                        <span class="help-text" style="margin: 0; font-size: 0.75rem;">(Lower = more consistent scores)</span>
                    </div>

                    <!-- Naming Convention Notice -->
                    <div class="naming-convention-notice" id="batchNamingNoticeContainer">
                        <strong>üìã Required Naming Convention:</strong>
                        <code id="batchNamingPatternCode">FirstName_LastName_AssignmentName.docx</code>
                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">
                            Example: <code id="batchNamingExampleCode">John_Smith_PersuasiveEssay.docx</code> ‚Ä¢ Files not following this format will receive a <strong style="color: var(--danger);" id="batchNamingPenalty">-10 point penalty</strong>
                        </div>
                    </div>

                    <!-- Batch Upload Zone -->
                    <div class="batch-upload-zone" id="batchUploadZone" onclick="document.getElementById('batchFileInput').click()">
                        <input type="file" id="batchFileInput" accept=".txt,.docx,.pdf,.zip" multiple style="display: none;" onchange="handleBatchFileSelect(event)">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üìÅ</div>
                        <div style="font-weight: 500; margin-bottom: 0.25rem;">Drop essay files here or click to select</div>
                        <div style="font-size: 0.8125rem; color: var(--gray-500);">Supports .txt, .docx, .pdf, and <strong>.zip</strong> (Schoology bulk download)</div>
                    </div>

                    <!-- ZIP Processing Status -->
                    <div id="zipProcessingStatus" style="display: none; padding: 1rem; background: var(--gray-100); border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="loading-spinner" style="width: 20px; height: 20px;"></span>
                            <span id="zipStatusText">Extracting ZIP file...</span>
                        </div>
                    </div>

                    <!-- File List -->
                    <div class="batch-file-list" id="batchFileList"></div>

                    <!-- Queue Status (hidden by default) -->
                    <div class="queue-status" id="queueStatus" style="display: none;">
                        <div class="queue-progress">
                            <span id="queueCurrentName">Processing...</span>
                            <div class="queue-progress-bar">
                                <div class="queue-progress-fill" id="queueProgressFill" style="width: 0%"></div>
                            </div>
                            <span id="queueCount">0/0</span>
                        </div>
                        <div class="queue-text" id="queueText">Initializing...</div>
                    </div>

                    <div class="error-message" id="batchErrorMessage"></div>

                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-primary" style="flex: 1;" onclick="startBatchGrading()" id="batchGradeBtn" disabled>
                            <span>‚ú®</span> Grade All Essays (<span id="batchCount">0</span>)
                        </button>
                        <button class="btn btn-secondary" onclick="clearBatchFiles()" id="clearBatchBtn" style="display: none;">
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- Batch Results Container -->
                <div class="batch-results-container" id="batchResultsContainer">
                    <!-- Class Summary -->
                    <div class="class-summary" id="classSummary">
                        <h3>üìä Class Summary</h3>
                        <div class="summary-stats">
                            <div class="summary-stat">
                                <div class="stat-value" id="summaryTotal">0</div>
                                <div class="stat-label">Essays Graded</div>
                            </div>
                            <div class="summary-stat">
                                <div class="stat-value" id="summaryAvgGrammar">--%</div>
                                <div class="stat-label">Avg. Grammar</div>
                            </div>
                            <div class="summary-stat">
                                <div class="stat-value" id="summaryAvgSpelling">--%</div>
                                <div class="stat-label">Avg. Spelling</div>
                            </div>
                            <div class="summary-stat">
                                <div class="stat-value" id="summaryAvgOriginality">--%</div>
                                <div class="stat-label">Avg. Originality</div>
                            </div>
                            <div class="summary-stat">
                                <div class="stat-value" id="summaryAiFlags">0</div>
                                <div class="stat-label">AI Flags (Med/High)</div>
                            </div>
                        </div>

                        <!-- Export Actions -->
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200); flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="exportSchoologyCSV()" style="font-size: 0.8125rem; padding: 0.5rem 0.75rem;">
                                üì• Export to Schoology
                            </button>
                            <button class="btn btn-secondary" onclick="exportBatchResultsCSV()" style="font-size: 0.8125rem; padding: 0.5rem 0.75rem;">
                                üìä Export Full Report
                            </button>
                        </div>
                    </div>

                    <!-- Individual Essay Results -->
                    <div class="essay-results-stream" id="essayResultsStream">
                        <!-- Essay result cards will be inserted here -->
                    </div>
                </div>
            </div><!-- End Batch Mode -->

            <!-- STUDENT PROGRESS MODE -->
            <div id="progressMode" class="mode-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
                        <div>
                            <h2 class="card-title" style="margin-bottom: 0.25rem;">üìà Student Progress Tracking</h2>
                            <p style="color: var(--gray-500); font-size: 0.875rem; margin: 0;">
                                Track student writing improvement over time using <span style="background: var(--primary); color: white; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">üìä i-Ready</span> assessment metrics
                            </p>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="exportStudentDataCSV()" style="font-size: 0.8125rem; padding: 0.5rem 0.75rem;">
                                üì• Export CSV
                            </button>
                            <button class="btn btn-secondary" onclick="exportStudentDataJSON()" style="font-size: 0.8125rem; padding: 0.5rem 0.75rem;">
                                üì• Export JSON
                            </button>
                            <button class="btn btn-secondary" onclick="importStudentData()" style="font-size: 0.8125rem; padding: 0.5rem 0.75rem;">
                                üì§ Import
                            </button>
                        </div>
                    </div>

                    <!-- Search Bar -->
                    <div style="margin-bottom: 1.5rem;">
                        <div style="position: relative;">
                            <input type="text" id="studentSearchInput" placeholder="Search students by name..."
                                   oninput="handleStudentSearch(this.value)"
                                   style="width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 1rem; transition: all 0.2s;">
                            <span style="position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%); font-size: 1.125rem;">üîç</span>
                        </div>
                    </div>

                    <!-- Stats Overview -->
                    <div id="progressStats" class="progress-stats-grid" style="display: none; margin-bottom: 1.5rem;">
                        <!-- Stats will be populated dynamically -->
                    </div>

                    <!-- Student List / Details View -->
                    <div id="studentListView">
                        <div id="studentList" class="student-list">
                            <!-- Student cards will be populated here -->
                        </div>
                        <div id="noStudentsMessage" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                            <p style="font-size: 1.125rem; margin-bottom: 0.5rem;">No student records yet</p>
                            <p style="font-size: 0.875rem;">Grade essays with student names to start tracking progress.</p>
                        </div>
                    </div>

                    <!-- Student Detail View (hidden by default) -->
                    <div id="studentDetailView" style="display: none;">
                        <button class="btn btn-secondary" onclick="showStudentList()" style="margin-bottom: 1rem; font-size: 0.875rem;">
                            ‚Üê Back to All Students
                        </button>
                        <div id="studentDetailContent">
                            <!-- Student details will be populated here -->
                        </div>
                    </div>

                    <!-- Data Management Section -->
                    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
                        <div class="collapsible-header collapsed" onclick="toggleSection('dataManagementSection', this)" style="cursor: pointer;">
                            <h3 style="font-size: 0.9375rem; font-weight: 600; color: var(--gray-700); margin: 0;">‚öôÔ∏è Data Management</h3>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div class="collapsible-content collapsed" id="dataManagementSection" style="margin-top: 1rem;">
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                                <div style="flex: 1; min-width: 200px;">
                                    <p style="font-size: 0.8125rem; color: var(--gray-500); margin: 0;">
                                        Student data is stored locally in your browser. Export regularly to back up your data.
                                    </p>
                                </div>
                                <button class="btn" onclick="clearAllStudentData()" style="background: var(--danger); font-size: 0.8125rem; padding: 0.5rem 1rem;">
                                    üóëÔ∏è Clear All Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End Progress Mode -->
        </div>
    </div>

    <script>
        // Store the original essay text and current result globally
        let originalEssayText = '';
        let currentResult = null;
        let currentStudentName = '';

        // ==========================================
        // TEACHER PREFERENCES SYSTEM
        // ==========================================

        // Naming convention patterns
        const NAMING_PATTERNS = {
            'firstname_lastname_assignment': {
                label: 'FirstName_LastName_Assignment',
                example: 'John_Smith_NarrativeEssay.docx',
                description: 'Standard format with first name, last name, then assignment'
            },
            'lastname_firstname_assignment': {
                label: 'LastName_FirstName_Assignment',
                example: 'Smith_John_NarrativeEssay.docx',
                description: 'Last name first, then first name, then assignment'
            },
            'studentid_assignment': {
                label: 'StudentID_Assignment',
                example: '12345_NarrativeEssay.docx',
                description: 'Student ID number followed by assignment name'
            },
            'lastname_assignment': {
                label: 'LastName_Assignment',
                example: 'Smith_NarrativeEssay.docx',
                description: 'Last name only followed by assignment name'
            },
            'firstname_lastname': {
                label: 'FirstName_LastName',
                example: 'John_Smith.docx',
                description: 'First name and last name only, no assignment name required'
            },
            'any_underscore': {
                label: 'Any Underscore-Separated',
                example: 'Any_Format_Works.docx',
                description: 'Any format with at least one underscore separator'
            }
        };

        // Default preferences
        const defaultPreferences = {
            naming: { enabled: true, penalty: 10, pattern: 'firstname_lastname_assignment' },
            grammar: { enabled: true, weight: 30, minPass: 60 },
            spelling: { enabled: true, weight: 20, minPass: 60 },
            originality: { enabled: true, weight: 30, minPass: 50 },
            apStyle: { enabled: false, weight: 20, minPass: 60 },
            aiDetection: { enabled: true, highPenalty: 0, mediumPenalty: 0 },
            late: { enabled: false, penaltyPerDay: 5, maxPenalty: 30 },
            wordCount: { enabled: false, min: 250, penalty: 10 },
            gradeLevel: { override: false, value: '8' }
        };

        // Presets for different grading styles
        const presets = {
            'default': { ...defaultPreferences },
            'strict': {
                naming: { enabled: true, penalty: 15, pattern: 'firstname_lastname_assignment' },
                grammar: { enabled: true, weight: 35, minPass: 70 },
                spelling: { enabled: true, weight: 25, minPass: 70 },
                originality: { enabled: true, weight: 25, minPass: 60 },
                apStyle: { enabled: false, weight: 15, minPass: 70 },
                aiDetection: { enabled: true, highPenalty: 25, mediumPenalty: 10 },
                late: { enabled: true, penaltyPerDay: 10, maxPenalty: 50 },
                wordCount: { enabled: true, min: 300, penalty: 15 },
                gradeLevel: { override: false, value: '8' }
            },
            'lenient': {
                naming: { enabled: true, penalty: 5, pattern: 'firstname_lastname_assignment' },
                grammar: { enabled: true, weight: 25, minPass: 50 },
                spelling: { enabled: true, weight: 15, minPass: 50 },
                originality: { enabled: true, weight: 35, minPass: 40 },
                apStyle: { enabled: false, weight: 25, minPass: 50 },
                aiDetection: { enabled: true, highPenalty: 0, mediumPenalty: 0 },
                late: { enabled: false, penaltyPerDay: 3, maxPenalty: 15 },
                wordCount: { enabled: false, min: 200, penalty: 5 },
                gradeLevel: { override: false, value: '8' }
            },
            'grammar-focus': {
                naming: { enabled: true, penalty: 10, pattern: 'firstname_lastname_assignment' },
                grammar: { enabled: true, weight: 50, minPass: 65 },
                spelling: { enabled: true, weight: 30, minPass: 65 },
                originality: { enabled: true, weight: 20, minPass: 50 },
                apStyle: { enabled: false, weight: 0, minPass: 60 },
                aiDetection: { enabled: true, highPenalty: 0, mediumPenalty: 0 },
                late: { enabled: false, penaltyPerDay: 5, maxPenalty: 30 },
                wordCount: { enabled: false, min: 250, penalty: 10 },
                gradeLevel: { override: false, value: '8' }
            },
            'originality-focus': {
                naming: { enabled: true, penalty: 10, pattern: 'firstname_lastname_assignment' },
                grammar: { enabled: true, weight: 20, minPass: 55 },
                spelling: { enabled: true, weight: 15, minPass: 55 },
                originality: { enabled: true, weight: 50, minPass: 60 },
                apStyle: { enabled: false, weight: 15, minPass: 60 },
                aiDetection: { enabled: true, highPenalty: 15, mediumPenalty: 5 },
                late: { enabled: false, penaltyPerDay: 5, maxPenalty: 30 },
                wordCount: { enabled: false, min: 250, penalty: 10 },
                gradeLevel: { override: false, value: '8' }
            },
            'no-penalties': {
                naming: { enabled: false, penalty: 0, pattern: 'firstname_lastname_assignment' },
                grammar: { enabled: true, weight: 33, minPass: 60 },
                spelling: { enabled: true, weight: 33, minPass: 60 },
                originality: { enabled: true, weight: 34, minPass: 50 },
                apStyle: { enabled: false, weight: 0, minPass: 60 },
                aiDetection: { enabled: true, highPenalty: 0, mediumPenalty: 0 },
                late: { enabled: false, penaltyPerDay: 0, maxPenalty: 0 },
                wordCount: { enabled: false, min: 0, penalty: 0 },
                gradeLevel: { override: false, value: '8' }
            }
        };

        // Current preferences (loaded from storage or defaults)
        let teacherPreferences = JSON.parse(JSON.stringify(defaultPreferences));

        // Load preferences from localStorage
        function loadPreferencesFromStorage() {
            const saved = localStorage.getItem('essayGraderPreferences');
            if (saved) {
                try {
                    teacherPreferences = JSON.parse(saved);
                    applyPreferencesToUI();
                } catch (e) {
                    console.error('Error loading preferences:', e);
                    teacherPreferences = JSON.parse(JSON.stringify(defaultPreferences));
                }
            }
        }

        // Apply preferences to UI inputs
        function applyPreferencesToUI() {
            // Naming
            document.getElementById('prefNamingEnabled').checked = teacherPreferences.naming.enabled;
            document.getElementById('prefNamingPattern').value = teacherPreferences.naming.pattern || 'firstname_lastname_assignment';
            document.getElementById('prefNamingPenalty').value = teacherPreferences.naming.penalty;
            document.getElementById('prefNamingPattern').disabled = !teacherPreferences.naming.enabled;
            document.getElementById('prefNamingPenalty').disabled = !teacherPreferences.naming.enabled;
            updateNamingPatternDisplay();

            // Grammar
            document.getElementById('prefGrammarEnabled').checked = teacherPreferences.grammar.enabled;
            document.getElementById('prefGrammarWeight').value = teacherPreferences.grammar.weight;
            document.getElementById('prefGrammarMinPass').value = teacherPreferences.grammar.minPass;
            document.getElementById('prefGrammarWeight').disabled = !teacherPreferences.grammar.enabled;
            document.getElementById('prefGrammarMinPass').disabled = !teacherPreferences.grammar.enabled;

            // Spelling
            document.getElementById('prefSpellingEnabled').checked = teacherPreferences.spelling.enabled;
            document.getElementById('prefSpellingWeight').value = teacherPreferences.spelling.weight;
            document.getElementById('prefSpellingMinPass').value = teacherPreferences.spelling.minPass;
            document.getElementById('prefSpellingWeight').disabled = !teacherPreferences.spelling.enabled;
            document.getElementById('prefSpellingMinPass').disabled = !teacherPreferences.spelling.enabled;

            // Originality
            document.getElementById('prefOriginalityEnabled').checked = teacherPreferences.originality.enabled;
            document.getElementById('prefOriginalityWeight').value = teacherPreferences.originality.weight;
            document.getElementById('prefOriginalityMinPass').value = teacherPreferences.originality.minPass;
            document.getElementById('prefOriginalityWeight').disabled = !teacherPreferences.originality.enabled;
            document.getElementById('prefOriginalityMinPass').disabled = !teacherPreferences.originality.enabled;

            // AP Style
            document.getElementById('prefAPStyleEnabled').checked = teacherPreferences.apStyle.enabled;
            document.getElementById('prefAPStyleWeight').value = teacherPreferences.apStyle.weight;
            document.getElementById('prefAPStyleMinPass').value = teacherPreferences.apStyle.minPass;
            document.getElementById('prefAPStyleWeight').disabled = !teacherPreferences.apStyle.enabled;
            document.getElementById('prefAPStyleMinPass').disabled = !teacherPreferences.apStyle.enabled;

            // AI Detection
            document.getElementById('prefAIDetectionEnabled').checked = teacherPreferences.aiDetection.enabled;
            document.getElementById('prefAIHighPenalty').value = teacherPreferences.aiDetection.highPenalty;
            document.getElementById('prefAIMediumPenalty').value = teacherPreferences.aiDetection.mediumPenalty;
            document.getElementById('prefAIHighPenalty').disabled = !teacherPreferences.aiDetection.enabled;
            document.getElementById('prefAIMediumPenalty').disabled = !teacherPreferences.aiDetection.enabled;

            // Late Submission
            document.getElementById('prefLateEnabled').checked = teacherPreferences.late.enabled;
            document.getElementById('prefLatePenaltyPerDay').value = teacherPreferences.late.penaltyPerDay;
            document.getElementById('prefLateMaxPenalty').value = teacherPreferences.late.maxPenalty;
            document.getElementById('prefLatePenaltyPerDay').disabled = !teacherPreferences.late.enabled;
            document.getElementById('prefLateMaxPenalty').disabled = !teacherPreferences.late.enabled;

            // Word Count
            document.getElementById('prefWordCountEnabled').checked = teacherPreferences.wordCount.enabled;
            document.getElementById('prefWordCountMin').value = teacherPreferences.wordCount.min;
            document.getElementById('prefWordCountPenalty').value = teacherPreferences.wordCount.penalty;
            document.getElementById('prefWordCountMin').disabled = !teacherPreferences.wordCount.enabled;
            document.getElementById('prefWordCountPenalty').disabled = !teacherPreferences.wordCount.enabled;

            // Grade Level (with backwards compatibility)
            if (!teacherPreferences.gradeLevel) {
                teacherPreferences.gradeLevel = { override: false, value: '8' };
            }
            document.getElementById('prefGradeLevelOverride').checked = teacherPreferences.gradeLevel.override;
            document.getElementById('prefGradeLevelValue').value = teacherPreferences.gradeLevel.value;
            document.getElementById('prefGradeLevelValue').disabled = !teacherPreferences.gradeLevel.override;
        }

        // Update a specific preference
        function updatePreference(category, key, value) {
            // Ensure category exists (backwards compatibility)
            if (!teacherPreferences[category]) {
                teacherPreferences[category] = {};
            }

            if (key === 'enabled' || key === 'override') {
                teacherPreferences[category][key] = value;
                // Disable/enable related inputs
                const categoryMap = {
                    naming: ['prefNamingPattern', 'prefNamingPenalty'],
                    grammar: ['prefGrammarWeight', 'prefGrammarMinPass'],
                    spelling: ['prefSpellingWeight', 'prefSpellingMinPass'],
                    originality: ['prefOriginalityWeight', 'prefOriginalityMinPass'],
                    apStyle: ['prefAPStyleWeight', 'prefAPStyleMinPass'],
                    aiDetection: ['prefAIHighPenalty', 'prefAIMediumPenalty'],
                    late: ['prefLatePenaltyPerDay', 'prefLateMaxPenalty'],
                    wordCount: ['prefWordCountMin', 'prefWordCountPenalty'],
                    gradeLevel: ['prefGradeLevelValue']
                };
                if (categoryMap[category]) {
                    categoryMap[category].forEach(id => {
                        document.getElementById(id).disabled = !value;
                    });
                }
            } else if (category === 'gradeLevel' && key === 'value') {
                // Grade level value is a string, not an integer
                teacherPreferences[category][key] = value;
            } else if (category === 'naming' && key === 'pattern') {
                // Naming pattern is a string, not an integer
                teacherPreferences[category][key] = value;
            } else {
                teacherPreferences[category][key] = parseInt(value) || 0;
            }
            // Mark preset as custom
            document.getElementById('presetSelect').value = '';
        }

        // Load a preset
        function loadPreset(presetName) {
            if (presets[presetName]) {
                teacherPreferences = JSON.parse(JSON.stringify(presets[presetName]));
                applyPreferencesToUI();
            }
        }

        // Save preferences to localStorage
        function savePreferences() {
            localStorage.setItem('essayGraderPreferences', JSON.stringify(teacherPreferences));
            alert('‚úÖ Preferences saved successfully!');
        }

        // Reset to defaults
        function resetPreferences() {
            if (confirm('Reset all preferences to default values?')) {
                teacherPreferences = JSON.parse(JSON.stringify(defaultPreferences));
                applyPreferencesToUI();
                document.getElementById('presetSelect').value = 'default';
            }
        }

        // Update the naming pattern example display
        function updateNamingPatternDisplay() {
            const pattern = teacherPreferences.naming.pattern || 'firstname_lastname_assignment';
            const patternInfo = NAMING_PATTERNS[pattern];
            const penalty = teacherPreferences.naming.penalty || 10;

            // Update preferences panel example
            const exampleEl = document.getElementById('namingPatternExample');
            if (exampleEl && patternInfo) {
                exampleEl.textContent = `Example: ${patternInfo.example}`;
            }

            // Update batch mode notice elements
            const batchPatternEl = document.getElementById('batchNamingPatternCode');
            const batchExampleEl = document.getElementById('batchNamingExampleCode');
            const batchPenaltyEl = document.getElementById('batchNamingPenalty');

            if (batchPatternEl && patternInfo) {
                batchPatternEl.textContent = `${patternInfo.label}.docx`;
            }
            if (batchExampleEl && patternInfo) {
                batchExampleEl.textContent = patternInfo.example;
            }
            if (batchPenaltyEl) {
                batchPenaltyEl.textContent = `-${penalty} point penalty`;
            }
        }

        // Get the currently selected naming pattern info
        function getCurrentNamingPattern() {
            const pattern = teacherPreferences.naming.pattern || 'firstname_lastname_assignment';
            return {
                key: pattern,
                ...NAMING_PATTERNS[pattern]
            };
        }

        // Export preferences as JSON file
        function exportPreferences() {
            const dataStr = JSON.stringify(teacherPreferences, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'essay_grader_preferences.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Import preferences from JSON file
        function importPreferences() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const imported = JSON.parse(event.target.result);
                            teacherPreferences = imported;
                            applyPreferencesToUI();
                            document.getElementById('presetSelect').value = '';
                            alert('‚úÖ Preferences imported successfully!');
                        } catch (err) {
                            alert('‚ùå Error importing preferences: Invalid JSON file');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Get the naming penalty from preferences
        function getNamingPenalty() {
            return teacherPreferences.naming.enabled ? teacherPreferences.naming.penalty : 0;
        }

        // ============================================
        // STUDENT PROGRESS TRACKING SYSTEM
        // ============================================

        // Data structure for student records
        // Key: normalized student identifier (e.g., "john_smith" or "john.smith@school.edu")
        // Value: { name, email, essays: [...], lastUpdated }
        const STUDENT_DATA_KEY = 'essayGraderStudentData';

        // Load all student data from localStorage
        function loadStudentData() {
            const data = localStorage.getItem(STUDENT_DATA_KEY);
            return data ? JSON.parse(data) : {};
        }

        // Save all student data to localStorage
        function saveStudentData(data) {
            localStorage.setItem(STUDENT_DATA_KEY, JSON.stringify(data));
        }

        // Generate a normalized student ID from name
        function normalizeStudentId(name) {
            return name.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .trim()
                .replace(/\s+/g, '_');
        }

        // Save an essay result for a student
        function saveStudentEssay(studentName, essayResult, essayText, metadata = {}) {
            if (!studentName || studentName.trim() === '' || studentName === 'Student') {
                return false; // Don't save anonymous essays
            }

            const studentData = loadStudentData();
            const studentId = normalizeStudentId(studentName);

            if (!studentData[studentId]) {
                studentData[studentId] = {
                    name: studentName,
                    email: metadata.email || '',
                    essays: [],
                    createdAt: new Date().toISOString()
                };
            }

            // Create essay record
            const essayRecord = {
                id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
                date: new Date().toISOString(),
                gradeLevel: essayResult.detectedGradeLevel?.level || metadata.gradeLevel || 'unknown',
                scores: {
                    grammar: essayResult.grammar?.score || 0,
                    spelling: essayResult.spelling?.score || 0,
                    originality: essayResult.originality?.score || 0,
                    apStyle: essayResult.apStyle?.score || null
                },
                overallGrade: essayResult.overallGrade || 'N/A',
                wordCount: essayText ? essayText.trim().split(/\s+/).length : 0,
                aiDetection: essayResult.aiDetection?.likelihood || 'low',
                essayType: essayResult.essayType || metadata.essayType || 'unknown',
                filename: metadata.filename || '',
                iReadyAssessment: essayResult.detectedGradeLevel?.reasoning || ''
            };

            studentData[studentId].essays.push(essayRecord);
            studentData[studentId].lastUpdated = new Date().toISOString();

            saveStudentData(studentData);
            return true;
        }

        // Get a specific student's data
        function getStudentRecord(studentName) {
            const studentData = loadStudentData();
            const studentId = normalizeStudentId(studentName);
            return studentData[studentId] || null;
        }

        // Search students by name
        function searchStudents(query) {
            const studentData = loadStudentData();
            const normalizedQuery = query.toLowerCase().trim();

            return Object.values(studentData).filter(student =>
                student.name.toLowerCase().includes(normalizedQuery) ||
                (student.email && student.email.toLowerCase().includes(normalizedQuery))
            );
        }

        // Get all students
        function getAllStudents() {
            const studentData = loadStudentData();
            return Object.values(studentData).sort((a, b) =>
                a.name.localeCompare(b.name)
            );
        }

        // Calculate student progress metrics
        function calculateStudentProgress(student) {
            if (!student || !student.essays || student.essays.length === 0) {
                return null;
            }

            const essays = student.essays.sort((a, b) => new Date(a.date) - new Date(b.date));
            const recentEssays = essays.slice(-5); // Last 5 essays
            const firstHalf = essays.slice(0, Math.ceil(essays.length / 2));
            const secondHalf = essays.slice(Math.ceil(essays.length / 2));

            // Calculate averages
            const calcAvg = (arr, field) => {
                const values = arr.map(e => e.scores[field]).filter(v => v !== null && v !== undefined);
                return values.length ? Math.round(values.reduce((a, b) => a + b, 0) / values.length) : 0;
            };

            const overallProgress = {
                grammar: {
                    first: calcAvg(firstHalf, 'grammar'),
                    second: calcAvg(secondHalf, 'grammar'),
                    current: calcAvg(recentEssays, 'grammar'),
                    trend: 0
                },
                spelling: {
                    first: calcAvg(firstHalf, 'spelling'),
                    second: calcAvg(secondHalf, 'spelling'),
                    current: calcAvg(recentEssays, 'spelling'),
                    trend: 0
                },
                originality: {
                    first: calcAvg(firstHalf, 'originality'),
                    second: calcAvg(secondHalf, 'originality'),
                    current: calcAvg(recentEssays, 'originality'),
                    trend: 0
                }
            };

            // Calculate trends (positive = improvement)
            Object.keys(overallProgress).forEach(key => {
                overallProgress[key].trend = overallProgress[key].second - overallProgress[key].first;
            });

            return {
                totalEssays: essays.length,
                firstEssayDate: essays[0].date,
                lastEssayDate: essays[essays.length - 1].date,
                progress: overallProgress,
                averageWordCount: Math.round(essays.reduce((a, e) => a + e.wordCount, 0) / essays.length),
                gradeLevelRange: {
                    min: Math.min(...essays.map(e => parseInt(e.gradeLevel) || 6)),
                    max: Math.max(...essays.map(e => parseInt(e.gradeLevel) || 12))
                }
            };
        }

        // Export student data as JSON
        function exportStudentDataJSON() {
            const studentData = loadStudentData();
            const dataStr = JSON.stringify(studentData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `student_progress_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Export student data as CSV
        function exportStudentDataCSV() {
            const studentData = loadStudentData();
            const students = Object.values(studentData);

            // Build CSV rows
            const headers = ['Student Name', 'Email', 'Essay Date', 'Grade Level', 'Grammar', 'Spelling', 'Originality', 'Overall Grade', 'Word Count', 'AI Detection', 'Essay Type'];
            const rows = [headers.join(',')];

            students.forEach(student => {
                student.essays.forEach(essay => {
                    const row = [
                        `"${student.name}"`,
                        `"${student.email || ''}"`,
                        new Date(essay.date).toLocaleDateString(),
                        essay.gradeLevel,
                        essay.scores.grammar,
                        essay.scores.spelling,
                        essay.scores.originality,
                        `"${essay.overallGrade}"`,
                        essay.wordCount,
                        essay.aiDetection,
                        `"${essay.essayType}"`
                    ];
                    rows.push(row.join(','));
                });
            });

            const csvContent = rows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `student_progress_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Import student data from JSON
        function importStudentData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const imported = JSON.parse(event.target.result);

                            // Merge with existing data
                            const existingData = loadStudentData();
                            let newCount = 0;
                            let updateCount = 0;

                            Object.entries(imported).forEach(([studentId, studentRecord]) => {
                                if (!existingData[studentId]) {
                                    existingData[studentId] = studentRecord;
                                    newCount++;
                                } else {
                                    // Merge essays (avoid duplicates by ID)
                                    const existingIds = new Set(existingData[studentId].essays.map(e => e.id));
                                    studentRecord.essays.forEach(essay => {
                                        if (!existingIds.has(essay.id)) {
                                            existingData[studentId].essays.push(essay);
                                            updateCount++;
                                        }
                                    });
                                    existingData[studentId].lastUpdated = new Date().toISOString();
                                }
                            });

                            saveStudentData(existingData);
                            alert(`‚úÖ Import successful!\n${newCount} new students added\n${updateCount} essays merged`);
                            refreshStudentProgressPanel();
                        } catch (err) {
                            alert('‚ùå Error importing data: Invalid JSON file');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Delete a student's records
        function deleteStudentRecord(studentName) {
            if (!confirm(`Are you sure you want to delete all records for "${studentName}"? This cannot be undone.`)) {
                return;
            }
            const studentData = loadStudentData();
            const studentId = normalizeStudentId(studentName);
            delete studentData[studentId];
            saveStudentData(studentData);
            refreshStudentProgressPanel();
        }

        // Clear all student data
        function clearAllStudentData() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete ALL student records? This cannot be undone!')) {
                return;
            }
            if (!confirm('This will permanently remove all student progress data. Type "DELETE" to confirm.')) {
                return;
            }
            localStorage.removeItem(STUDENT_DATA_KEY);
            refreshStudentProgressPanel();
            alert('All student data has been cleared.');
        }

        // ============================================
        // STUDENT PROGRESS UI FUNCTIONS
        // ============================================

        // Refresh the student progress panel
        function refreshStudentProgressPanel() {
            const students = getAllStudents();
            const statsEl = document.getElementById('progressStats');
            const listEl = document.getElementById('studentList');
            const noStudentsEl = document.getElementById('noStudentsMessage');

            if (students.length === 0) {
                statsEl.style.display = 'none';
                listEl.innerHTML = '';
                noStudentsEl.style.display = 'block';
                return;
            }

            noStudentsEl.style.display = 'none';
            statsEl.style.display = 'grid';

            // Calculate overall stats
            const totalEssays = students.reduce((sum, s) => sum + s.essays.length, 0);
            const avgGrammar = Math.round(students.reduce((sum, s) => {
                const avg = s.essays.reduce((a, e) => a + e.scores.grammar, 0) / s.essays.length;
                return sum + avg;
            }, 0) / students.length);
            const avgSpelling = Math.round(students.reduce((sum, s) => {
                const avg = s.essays.reduce((a, e) => a + e.scores.spelling, 0) / s.essays.length;
                return sum + avg;
            }, 0) / students.length);
            const avgOriginality = Math.round(students.reduce((sum, s) => {
                const avg = s.essays.reduce((a, e) => a + e.scores.originality, 0) / s.essays.length;
                return sum + avg;
            }, 0) / students.length);

            // Render stats
            statsEl.innerHTML = `
                <div class="progress-stat-card">
                    <div class="progress-stat-value">${students.length}</div>
                    <div class="progress-stat-label">Students</div>
                </div>
                <div class="progress-stat-card">
                    <div class="progress-stat-value">${totalEssays}</div>
                    <div class="progress-stat-label">Essays Graded</div>
                </div>
                <div class="progress-stat-card">
                    <div class="progress-stat-value">${avgGrammar}%</div>
                    <div class="progress-stat-label">Avg Grammar</div>
                </div>
                <div class="progress-stat-card">
                    <div class="progress-stat-value">${avgSpelling}%</div>
                    <div class="progress-stat-label">Avg Spelling</div>
                </div>
                <div class="progress-stat-card">
                    <div class="progress-stat-value">${avgOriginality}%</div>
                    <div class="progress-stat-label">Avg Originality</div>
                </div>
            `;

            // Render student list
            listEl.innerHTML = students.map(student => {
                const progress = calculateStudentProgress(student);
                const recentAvg = progress ? {
                    grammar: progress.progress.grammar.current,
                    spelling: progress.progress.spelling.current,
                    originality: progress.progress.originality.current
                } : { grammar: 0, spelling: 0, originality: 0 };

                // Calculate overall trend
                let overallTrend = 0;
                if (progress) {
                    overallTrend = Math.round(
                        (progress.progress.grammar.trend +
                         progress.progress.spelling.trend +
                         progress.progress.originality.trend) / 3
                    );
                }

                const trendClass = overallTrend > 0 ? 'up' : overallTrend < 0 ? 'down' : 'neutral';
                const trendIcon = overallTrend > 0 ? '‚Üë' : overallTrend < 0 ? '‚Üì' : '‚Üí';

                return `
                    <div class="student-card" onclick="showStudentDetail('${encodeURIComponent(student.name)}')">
                        <div class="student-card-info">
                            <div class="student-card-name">${student.name}</div>
                            <div class="student-card-meta">
                                <span>üìù ${student.essays.length} essay${student.essays.length !== 1 ? 's' : ''}</span>
                                <span>üìÖ Last: ${new Date(student.lastUpdated).toLocaleDateString()}</span>
                                ${student.essays.length >= 2 ? `<span class="trend-indicator ${trendClass}">${trendIcon} ${Math.abs(overallTrend)}pts</span>` : ''}
                            </div>
                        </div>
                        <div class="student-card-scores">
                            <div class="mini-score grammar">
                                <span>${recentAvg.grammar}</span>
                                <span class="mini-score-label">Gram</span>
                            </div>
                            <div class="mini-score spelling">
                                <span>${recentAvg.spelling}</span>
                                <span class="mini-score-label">Spell</span>
                            </div>
                            <div class="mini-score originality">
                                <span>${recentAvg.originality}</span>
                                <span class="mini-score-label">Orig</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Handle student search
        function handleStudentSearch(query) {
            const listEl = document.getElementById('studentList');
            const noStudentsEl = document.getElementById('noStudentsMessage');

            if (!query.trim()) {
                refreshStudentProgressPanel();
                return;
            }

            const results = searchStudents(query);

            if (results.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîç</div>
                        <p>No students found matching "${query}"</p>
                    </div>
                `;
                noStudentsEl.style.display = 'none';
                return;
            }

            noStudentsEl.style.display = 'none';

            // Render filtered results (same format as refreshStudentProgressPanel)
            listEl.innerHTML = results.map(student => {
                const progress = calculateStudentProgress(student);
                const recentAvg = progress ? {
                    grammar: progress.progress.grammar.current,
                    spelling: progress.progress.spelling.current,
                    originality: progress.progress.originality.current
                } : { grammar: 0, spelling: 0, originality: 0 };

                let overallTrend = 0;
                if (progress) {
                    overallTrend = Math.round(
                        (progress.progress.grammar.trend +
                         progress.progress.spelling.trend +
                         progress.progress.originality.trend) / 3
                    );
                }

                const trendClass = overallTrend > 0 ? 'up' : overallTrend < 0 ? 'down' : 'neutral';
                const trendIcon = overallTrend > 0 ? '‚Üë' : overallTrend < 0 ? '‚Üì' : '‚Üí';

                return `
                    <div class="student-card" onclick="showStudentDetail('${encodeURIComponent(student.name)}')">
                        <div class="student-card-info">
                            <div class="student-card-name">${student.name}</div>
                            <div class="student-card-meta">
                                <span>üìù ${student.essays.length} essay${student.essays.length !== 1 ? 's' : ''}</span>
                                <span>üìÖ Last: ${new Date(student.lastUpdated).toLocaleDateString()}</span>
                                ${student.essays.length >= 2 ? `<span class="trend-indicator ${trendClass}">${trendIcon} ${Math.abs(overallTrend)}pts</span>` : ''}
                            </div>
                        </div>
                        <div class="student-card-scores">
                            <div class="mini-score grammar">
                                <span>${recentAvg.grammar}</span>
                                <span class="mini-score-label">Gram</span>
                            </div>
                            <div class="mini-score spelling">
                                <span>${recentAvg.spelling}</span>
                                <span class="mini-score-label">Spell</span>
                            </div>
                            <div class="mini-score originality">
                                <span>${recentAvg.originality}</span>
                                <span class="mini-score-label">Orig</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show student detail view
        function showStudentDetail(encodedName) {
            const studentName = decodeURIComponent(encodedName);
            const student = getStudentRecord(studentName);

            if (!student) {
                alert('Student not found');
                return;
            }

            document.getElementById('studentListView').style.display = 'none';
            document.getElementById('studentDetailView').style.display = 'block';

            const progress = calculateStudentProgress(student);
            const contentEl = document.getElementById('studentDetailContent');

            // Build progress visualization
            let progressHtml = '';
            if (progress && student.essays.length >= 2) {
                const buildTrendBar = (label, data, color) => {
                    const trend = data.trend;
                    const trendClass = trend > 0 ? 'up' : trend < 0 ? 'down' : 'neutral';
                    const trendIcon = trend > 0 ? '‚Üë' : trend < 0 ? '‚Üì' : '‚Üí';
                    return `
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600; color: var(--gray-700);">${label}</span>
                                <span class="trend-indicator ${trendClass}">${trendIcon} ${Math.abs(trend)} pts ${trend >= 0 ? 'improvement' : 'decline'}</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <div style="flex: 1; background: var(--gray-200); border-radius: 4px; height: 8px; overflow: hidden;">
                                    <div style="width: ${data.first}%; height: 100%; background: ${color}40;"></div>
                                </div>
                                <span style="font-size: 0.75rem; color: var(--gray-500); width: 35px;">${data.first}%</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 0.25rem;">
                                <div style="flex: 1; background: var(--gray-200); border-radius: 4px; height: 8px; overflow: hidden;">
                                    <div style="width: ${data.current}%; height: 100%; background: ${color};"></div>
                                </div>
                                <span style="font-size: 0.75rem; color: var(--gray-500); width: 35px;">${data.current}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.6875rem; color: var(--gray-400); margin-top: 0.25rem;">
                                <span>First essays avg</span>
                                <span>Recent essays avg</span>
                            </div>
                        </div>
                    `;
                };

                progressHtml = `
                    <div class="progress-chart-container">
                        <div class="progress-chart-title">üìà Writing Progress Over Time</div>
                        ${buildTrendBar('Grammar', progress.progress.grammar, '#10b981')}
                        ${buildTrendBar('Spelling', progress.progress.spelling, '#3b82f6')}
                        ${buildTrendBar('Originality', progress.progress.originality, '#a855f7')}
                    </div>
                `;
            } else {
                progressHtml = `
                    <div style="background: var(--gray-50); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center; color: var(--gray-500);">
                        <p>üìä Progress trends will appear after 2+ essays are graded</p>
                    </div>
                `;
            }

            // Build essay history table
            const sortedEssays = [...student.essays].sort((a, b) => new Date(b.date) - new Date(a.date));
            const getScoreClass = (score) => score >= 80 ? 'high' : score >= 60 ? 'medium' : 'low';

            contentEl.innerHTML = `
                <div class="student-detail-header">
                    <div>
                        <div class="student-detail-name">${student.name}</div>
                        <div class="student-detail-info">
                            <span>üìù ${student.essays.length} essays graded</span>
                            <span>üìÖ First essay: ${new Date(student.createdAt).toLocaleDateString()}</span>
                            ${progress ? `<span>üìä Avg word count: ${progress.averageWordCount} words</span>` : ''}
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="deleteStudentRecord('${student.name}')" style="font-size: 0.8125rem; padding: 0.5rem 0.75rem; background: var(--danger); color: white;">
                        üóëÔ∏è Delete Student
                    </button>
                </div>

                ${progressHtml}

                <div style="margin-bottom: 1rem;">
                    <h3 style="font-size: 1rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1rem;">üìã Essay History</h3>
                    <div style="overflow-x: auto;">
                        <table class="essay-history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Grade Level</th>
                                    <th>Grammar</th>
                                    <th>Spelling</th>
                                    <th>Originality</th>
                                    <th>Overall</th>
                                    <th>Words</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedEssays.map(essay => `
                                    <tr>
                                        <td>${new Date(essay.date).toLocaleDateString()}</td>
                                        <td>
                                            <span style="display: inline-flex; align-items: center; gap: 0.25rem;">
                                                ${essay.gradeLevel}th
                                                <span style="background: var(--primary); color: white; padding: 0.0625rem 0.25rem; border-radius: 3px; font-size: 0.5625rem; font-weight: 600;">i-Ready</span>
                                            </span>
                                        </td>
                                        <td><span class="score-badge ${getScoreClass(essay.scores.grammar)}">${essay.scores.grammar}%</span></td>
                                        <td><span class="score-badge ${getScoreClass(essay.scores.spelling)}">${essay.scores.spelling}%</span></td>
                                        <td><span class="score-badge ${getScoreClass(essay.scores.originality)}">${essay.scores.originality}%</span></td>
                                        <td style="font-weight: 600;">${essay.overallGrade}</td>
                                        <td>${essay.wordCount}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Show student list view (back from detail)
        function showStudentList() {
            document.getElementById('studentDetailView').style.display = 'none';
            document.getElementById('studentListView').style.display = 'block';
            document.getElementById('studentSearchInput').value = '';
            refreshStudentProgressPanel();
        }

        // Apply all penalties based on preferences
        function applyPreferencePenalties(result, essayText, namingViolation) {
            const penalties = [];

            // Naming convention penalty
            if (namingViolation && teacherPreferences.naming.enabled) {
                const penalty = teacherPreferences.naming.penalty;
                result.grammar.score = Math.max(0, result.grammar.score - penalty);
                result.spelling.score = Math.max(0, result.spelling.score - penalty);
                result.originality.score = Math.max(0, result.originality.score - penalty);
                penalties.push({ type: 'naming', amount: penalty, reason: 'Incorrect file naming format' });
            }

            // AI Detection penalty
            if (teacherPreferences.aiDetection.enabled && result.aiDetection) {
                let aiPenalty = 0;
                if (result.aiDetection.likelihood === 'high') {
                    aiPenalty = teacherPreferences.aiDetection.highPenalty;
                } else if (result.aiDetection.likelihood === 'medium') {
                    aiPenalty = teacherPreferences.aiDetection.mediumPenalty;
                }
                if (aiPenalty > 0) {
                    result.grammar.score = Math.max(0, result.grammar.score - aiPenalty);
                    result.spelling.score = Math.max(0, result.spelling.score - aiPenalty);
                    result.originality.score = Math.max(0, result.originality.score - aiPenalty);
                    penalties.push({ type: 'ai', amount: aiPenalty, reason: `AI detection: ${result.aiDetection.likelihood}` });
                }
            }

            // Word count penalty
            if (teacherPreferences.wordCount.enabled) {
                const wordCount = essayText.trim().split(/\s+/).length;
                if (wordCount < teacherPreferences.wordCount.min) {
                    const penalty = teacherPreferences.wordCount.penalty;
                    result.grammar.score = Math.max(0, result.grammar.score - penalty);
                    result.spelling.score = Math.max(0, result.spelling.score - penalty);
                    result.originality.score = Math.max(0, result.originality.score - penalty);
                    penalties.push({ type: 'wordCount', amount: penalty, reason: `Under minimum word count (${wordCount}/${teacherPreferences.wordCount.min})` });
                }
            }

            result.appliedPenalties = penalties;
            return result;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('essayGraderApiKey');
            const savedProvider = localStorage.getItem('essayGraderProvider');

            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                document.getElementById('rememberKey').checked = true;
            } else {
                // If no API key saved, expand the API config section
                const apiSection = document.getElementById('apiSection');
                const apiHeader = apiSection.previousElementSibling;
                apiSection.classList.remove('collapsed');
                apiHeader.classList.remove('collapsed');
            }
            if (savedProvider) {
                document.getElementById('apiProvider').value = savedProvider;
            }

            // Load teacher preferences
            loadPreferencesFromStorage();

            // Update naming pattern displays
            updateNamingPatternDisplay();

            updateConnectionStatus();
        });

        function togglePassword() {
            const input = document.getElementById('apiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tab === 'paste') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('pasteTab').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('uploadTab').classList.add('active');
            }
        }

        function updateCharCount() {
            const text = document.getElementById('essayText').value;
            document.getElementById('charCount').textContent = text.length;
            document.getElementById('wordCount').textContent = text.trim() ? text.trim().split(/\s+/).length : 0;
        }

        // AP Style toggle
        let apStyleEnabled = false;

        function toggleAPStyle() {
            apStyleEnabled = !apStyleEnabled;
            const toggle = document.getElementById('apStyleToggle');
            toggle.classList.toggle('active', apStyleEnabled);
        }

        // Extract student name from filename
        function extractStudentName(filename) {
            let name = filename.replace(/\.(txt|docx|pdf)$/i, '');
            const essayWords = /\b(essay|assignment|paper|draft|final|homework|hw|submission|narrative|persuasive|expository|descriptive|english|ela|writing)\b/gi;
            name = name.replace(essayWords, '');
            name = name.replace(/[_-]+/g, ' ');
            name = name.replace(/\s+/g, ' ').trim();
            name = name.replace(/\b\d+\b/g, '').trim();
            name = name.replace(/[^a-zA-Z\s,]/g, '').trim();

            if (name.includes(',')) {
                const parts = name.split(',').map(p => p.trim());
                if (parts.length === 2 && parts[0] && parts[1]) {
                    name = `${parts[1]} ${parts[0]}`;
                }
            }

            name = name.replace(/\s+/g, ' ').trim();
            name = name.split(' ')
                .filter(word => word.length > 0)
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');

            return name.length >= 2 ? name : '';
        }

        // Extract text from PDF
        async function extractTextFromPDF(arrayBuffer) {
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
            }

            return fullText.trim();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = file.name;

            const extractedName = extractStudentName(file.name);
            if (extractedName) {
                document.getElementById('studentName').value = extractedName;
            }

            try {
                let text = '';

                if (file.name.toLowerCase().endsWith('.txt')) {
                    text = await file.text();
                } else if (file.name.toLowerCase().endsWith('.docx')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    text = result.value;
                } else if (file.name.toLowerCase().endsWith('.pdf')) {
                    const arrayBuffer = await file.arrayBuffer();
                    text = await extractTextFromPDF(arrayBuffer);
                }

                document.getElementById('essayText').value = text;
                updateCharCount();
                switchTab('paste');
            } catch (error) {
                showError('Failed to read file: ' + error.message);
            }
        }

        function updateConnectionStatus() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            if (apiKey) {
                statusDot.classList.add('connected');
                statusText.textContent = 'API Key Entered';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'API Not Connected';
            }
        }

        document.getElementById('apiKey').addEventListener('input', () => {
            updateConnectionStatus();

            if (document.getElementById('rememberKey').checked) {
                localStorage.setItem('essayGraderApiKey', document.getElementById('apiKey').value);
            }
        });

        document.getElementById('apiProvider').addEventListener('change', () => {
            localStorage.setItem('essayGraderProvider', document.getElementById('apiProvider').value);
        });

        document.getElementById('rememberKey').addEventListener('change', (e) => {
            if (e.target.checked) {
                localStorage.setItem('essayGraderApiKey', document.getElementById('apiKey').value);
            } else {
                localStorage.removeItem('essayGraderApiKey');
            }
        });

        async function testConnection() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const provider = document.getElementById('apiProvider').value;

            if (!apiKey) {
                showError('Please enter an API key first.');
                return;
            }

            try {
                if (provider === 'anthropic') {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 10,
                            messages: [{ role: 'user', content: 'Hi' }]
                        })
                    });

                    if (response.ok) {
                        alert('‚úÖ Connection successful! Your Anthropic API key is working.');
                    } else {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'Connection failed');
                    }
                } else {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            max_tokens: 10,
                            messages: [{ role: 'user', content: 'Hi' }]
                        })
                    });

                    if (response.ok) {
                        alert('‚úÖ Connection successful! Your OpenAI API key is working.');
                    } else {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'Connection failed');
                    }
                }
            } catch (error) {
                showError('Connection failed: ' + error.message);
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('visible');
            setTimeout(() => errorEl.classList.remove('visible'), 5000);
        }

        async function gradeEssay() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const provider = document.getElementById('apiProvider').value;
            const essayText = document.getElementById('essayText').value.trim();
            const studentName = document.getElementById('studentName').value.trim() || 'Student';

            // Check if grade level override is enabled in preferences
            const gradeLevelOverride = teacherPreferences.gradeLevel?.override;
            const forcedGradeLevel = teacherPreferences.gradeLevel?.value || '8';

            // Store globally for use in display
            originalEssayText = essayText;
            currentStudentName = studentName;

            if (!apiKey) {
                showError('Please enter an API key first.');
                return;
            }

            if (!essayText) {
                showError('Please enter or upload an essay to grade.');
                return;
            }

            if (essayText.split(/\s+/).length < 20) {
                showError('Essay is too short. Please enter at least 20 words for accurate assessment.');
                return;
            }

            // Show loading
            document.getElementById('placeholder').style.display = 'none';
            document.getElementById('results').classList.remove('visible');
            document.getElementById('loading').classList.add('visible');
            document.getElementById('gradeBtn').disabled = true;

            // Build AP Style section if enabled
            const apStyleSection = apStyleEnabled ? `
    "apStyle": {
        "score": <number 0-100>,
        "feedback": ["<specific AP style feedback 1>", "<specific AP style feedback 2>", "<specific AP style feedback 3>"],
        "corrections": [
            {"original": "<exact text from essay>", "correction": "<corrected AP style version>"},
            {"original": "<another violation>", "correction": "<its correction>"}
        ]
    },` : '';

            const apStyleGuidelines = apStyleEnabled ? `
- AP Style: Evaluate adherence to Associated Press style guidelines including:
  * Numbers: Spell out one through nine, use figures for 10 and above
  * Dates: Use month abbreviations (Jan., Feb., Aug., Sept., Oct., Nov., Dec.) with specific dates
  * Titles: Capitalize formal titles before names, lowercase after
  * Punctuation: No Oxford comma, single space after periods
  * Time: Use figures with a.m. and p.m. (lowercase with periods)
  * Percentages: Use figures with "percent" spelled out
  * Ages: Always use figures for ages
  * Money: Use $ symbol with figures` : '';

            // Determine if we should auto-detect or use forced grade level
            const gradeLevelInstruction = gradeLevelOverride
                ? `The teacher has specified this is a ${forcedGradeLevel}th grade student. Grade accordingly.`
                : `FIRST, analyze the essay using i-Ready Reading and Writing assessment metrics to determine the student's actual writing grade level (6-12). Then grade the essay according to that detected level.`;

            // IMPORTANT: Include student name in the prompt to ensure correct reference
            const prompt = `You are an expert English teacher (grades 6-12) assessing a student's essay.

IMPORTANT: The student's name is "${studentName}". When providing feedback, ALWAYS refer to the student as "${studentName}" - never use any other name.${apStyleEnabled ? ' Also evaluate the essay for AP (Associated Press) style compliance.' : ''}

${gradeLevelInstruction}

ESSAY TO ANALYZE:
"""
${essayText}
"""

Provide your assessment in the following JSON format ONLY (no additional text):
{
    "grammar": {
        "score": <number 0-100>,
        "feedback": ["<specific feedback for ${studentName}>", "<another specific point>", "<another point>"],
        "corrections": [
            {"original": "<exact phrase from essay with grammar error>", "correction": "<corrected version>"},
            {"original": "<another exact phrase>", "correction": "<its correction>"}
        ]
    },
    "spelling": {
        "score": <number 0-100>,
        "feedback": ["<specific feedback for ${studentName}>", "<another point>", "<another point>"],
        "corrections": [
            {"original": "<misspelled word exactly as it appears>", "correction": "<correct spelling>"},
            {"original": "<another misspelled word>", "correction": "<correct spelling>"}
        ]
    },
    "originality": {
        "score": <number 0-100>,
        "feedback": ["<specific feedback for ${studentName}>", "<another point>", "<another point>"]
    },${apStyleSection}
    "aiDetection": {
        "likelihood": "<low|medium|high>",
        "confidence": <number 0-100>,
        "reasoning": "<brief explanation>",
        "redFlags": ["<specific telltale sign found in essay>", "<another red flag>"],
        "suspiciousExcerpts": ["<exact quote from essay that seems AI-generated>", "<another suspicious phrase>"]
    },
    "detectedEssayType": "<narrative|persuasive|expository|descriptive|argumentative|compare-contrast|cause-effect|personal>",
    "detectedTone": "<formal|informal|academic|conversational|emotional|objective|persuasive|reflective>",
    "strengths": ["<what ${studentName} did well - be specific>", "<another strength>", "<another strength>"],
    "improvements": ["<specific area ${studentName} should work on>", "<another area>", "<another area>"],
    "overallFeedback": "<2-3 sentences of encouraging feedback for ${studentName}, using their name, highlighting what they did well and one main area for improvement>",
    "detectedGradeLevel": {
        "level": <number 6-12 representing the grade level the student is writing at>,
        "confidence": "<low|medium|high>",
        "reasoning": "<brief explanation of why this grade level was determined based on i-Ready metrics>"
    }
}

i-READY WRITING ASSESSMENT METRICS FOR GRADE LEVEL DETECTION:
Analyze the essay against these grade-level benchmarks:

GRADE 6 INDICATORS:
- Simple sentence structures with occasional compound sentences
- Basic transitions (first, then, next, finally)
- Vocabulary at 6th grade level (~12,000 word recognition)
- Topic sentences present but may lack sophistication
- Basic organizational structure (intro, body, conclusion)
- Simple evidence/examples to support ideas

GRADE 7 INDICATORS:
- Mix of simple, compound, and some complex sentences
- More varied transitions (however, therefore, in addition)
- Expanded vocabulary with some domain-specific terms
- Clearer thesis statements
- Better paragraph development
- Multiple pieces of evidence with basic analysis

GRADE 8 INDICATORS:
- Complex sentences used appropriately
- Sophisticated transitions (nevertheless, consequently, furthermore)
- Academic vocabulary integration
- Strong thesis with clear roadmap
- Well-developed paragraphs with topic sentences
- Evidence with explanation and connection to thesis

GRADE 9-10 INDICATORS:
- Varied sentence structures for rhetorical effect
- Nuanced transitions that connect ideas seamlessly
- Domain-specific academic vocabulary
- Arguable, specific thesis statements
- Cohesive paragraphs with logical flow
- Integrated evidence with thorough analysis

GRADE 11-12 INDICATORS:
- Sophisticated syntax variety for emphasis and style
- Seamless, implicit transitions
- Advanced academic and discipline-specific vocabulary
- Complex, nuanced thesis addressing counterarguments
- Sophisticated paragraph structure with smooth transitions
- Expert integration of evidence with insightful analysis
- Mature voice and style

GRADING GUIDELINES (grade according to detected or specified level):
- Grammar: sentence structure, punctuation, capitalization, subject-verb agreement
- Spelling: identify EXACT misspelled words as they appear in the essay
- Originality: vocabulary variety, unique expressions, personal voice
- IMPORTANT FOR REDLINING: For each error, provide both the EXACT text from the essay AND the corrected version
- Grammar corrections: Include the exact phrase with the error AND how it should be written correctly
- Spelling corrections: Include the exact misspelled word AND the correct spelling

AI DETECTION - CRITICAL TELLTALE SIGNS TO FLAG:
Look for these specific AI writing indicators and LIST THEM in redFlags (consider the detected/specified grade level):
1. EM-DASHES (‚Äî): AI overuses em-dashes. Flag any em-dash usage as suspicious for students below 10th grade
2. CLICH√â OPENERS: "I hope this finds you well", "In today's world", "Throughout history", "In conclusion"
3. TRANSITION OVERUSE: Excessive use of "Furthermore", "Moreover", "Additionally", "In essence", "It's worth noting"
4. VOCABULARY MISMATCH: Words too advanced for the grade level (e.g., "paramount", "multifaceted", "nuanced", "delve" for middle schoolers)
5. PERFECT STRUCTURE: Unnaturally perfect 5-paragraph structure with identical paragraph lengths
6. HEDGING PHRASES: "It could be argued", "One might say", "It's important to note"
7. LIST-LIKE WRITING: Phrases like "First and foremost", "Last but not least", "All in all"
8. ROBOTIC CONSISTENCY: Every paragraph starts the same way or follows identical patterns
9. LACK OF PERSONAL VOICE: No contractions, no informal language, no personal anecdotes when expected
10. SOPHISTICATED CONJUNCTIONS: Overuse of "however", "nevertheless", "consequently" by middle/early high schoolers

For suspiciousExcerpts: Quote the EXACT phrases from the essay that triggered these red flags.
If redFlags is empty, the essay appears human-written.

ESSAY TYPE AUTO-DETECTION:
Analyze the essay structure and purpose to determine type:
- narrative: Tells a story, has characters, plot, setting
- persuasive: Tries to convince reader, has arguments and evidence
- expository: Explains or informs about a topic
- descriptive: Uses sensory details to describe something
- argumentative: Takes a position and defends it with logic
- compare-contrast: Examines similarities and differences
- cause-effect: Explores causes and their effects
- personal: Personal reflection or memoir-style

TONE AUTO-DETECTION:
Determine the writing tone:
- formal: Academic language, no contractions, professional
- informal: Casual, conversational, uses contractions
- academic: Scholarly, uses citations or evidence
- conversational: Like talking to a friend
- emotional: Expressive, uses feeling words
- objective: Neutral, factual, unbiased
- persuasive: Convincing, uses rhetorical devices
- reflective: Thoughtful, introspective${apStyleGuidelines}

CRITICAL: Always refer to the student as "${studentName}" in all feedback. Never use placeholder names like "the student" or any other name.

Return ONLY valid JSON, no markdown formatting or code blocks.`;

            try {
                let result;

                if (provider === 'anthropic') {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 3000,
                            messages: [{ role: 'user', content: prompt }]
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'API request failed');
                    }

                    const data = await response.json();
                    result = parseJSONResponse(data.content[0].text);
                } else {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o',
                            max_tokens: 3000,
                            messages: [{ role: 'user', content: prompt }]
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'API request failed');
                    }

                    const data = await response.json();
                    result = parseJSONResponse(data.choices[0].message.content);
                }

                currentResult = result;
                // Get grade level from result (auto-detected) or from override preference
                const displayGradeLevel = result.detectedGradeLevel?.level || (gradeLevelOverride ? forcedGradeLevel : '8');
                displayResults(result, studentName, displayGradeLevel);
            } catch (error) {
                showError('Failed to grade essay: ' + error.message);
                document.getElementById('loading').classList.remove('visible');
                document.getElementById('placeholder').style.display = 'block';
            } finally {
                document.getElementById('gradeBtn').disabled = false;
            }
        }

        function highlightErrors(text, result) {
            let highlightedText = text;

            // Escape HTML in the text first
            highlightedText = highlightedText
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Collect all corrections to apply redlining
            const corrections = [];

            // Add spelling corrections
            if (result.spelling && result.spelling.corrections) {
                result.spelling.corrections.forEach(item => {
                    if (item && item.original && item.original.length > 0) {
                        corrections.push({
                            original: item.original,
                            correction: item.correction || '?',
                            type: 'spelling'
                        });
                    }
                });
            }

            // Add grammar corrections
            if (result.grammar && result.grammar.corrections) {
                result.grammar.corrections.forEach(item => {
                    if (item && item.original && item.original.length > 1) {
                        corrections.push({
                            original: item.original,
                            correction: item.correction || '?',
                            type: 'grammar'
                        });
                    }
                });
            }

            // Add AP style corrections
            if (apStyleEnabled && result.apStyle && result.apStyle.corrections) {
                result.apStyle.corrections.forEach(item => {
                    if (item && item.original && item.original.length > 0) {
                        corrections.push({
                            original: item.original,
                            correction: item.correction || '?',
                            type: 'ap'
                        });
                    }
                });
            }

            // Sort by length (longest first) to avoid partial replacements
            corrections.sort((a, b) => b.original.length - a.original.length);

            // Apply redline markup (use a placeholder system to avoid double-highlighting)
            const placeholders = [];
            corrections.forEach((item, index) => {
                const escapedOriginal = item.original
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');

                const escapedCorrection = item.correction
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');

                const regex = new RegExp(escapedOriginal.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                const placeholder = `__REDLINE_${index}__`;

                if (highlightedText.match(regex)) {
                    highlightedText = highlightedText.replace(regex, (match) => {
                        // Create redline markup: strikethrough original + correction in brackets
                        const redlineHtml = `<span class="redline-error redline-${item.type}"><span class="redline-original">${match}</span><span class="redline-correction">${escapedCorrection}</span></span>`;
                        placeholders.push({
                            placeholder,
                            replacement: redlineHtml
                        });
                        return placeholder;
                    });
                }
            });

            // Replace placeholders with actual HTML
            placeholders.forEach(({ placeholder, replacement }) => {
                highlightedText = highlightedText.replace(placeholder, replacement);
            });

            // Convert newlines to paragraphs
            highlightedText = highlightedText
                .split(/\n\n+/)
                .map(para => `<p>${para.replace(/\n/g, '<br>')}</p>`)
                .join('');

            return highlightedText;
        }

        function displayResults(result, studentName, gradeLevel) {
            // Show the results card
            document.getElementById('resultsCard').style.display = 'block';
            document.getElementById('loading').classList.remove('visible');
            document.getElementById('results').classList.add('visible');

            // Reset edit mode when showing new results
            editModeEnabled = false;
            document.getElementById('highlightedEssay').contentEditable = 'false';
            document.getElementById('editorToolbar').style.display = 'none';
            document.getElementById('editModeBtn').textContent = '‚úèÔ∏è Enable Editing';

            // Student info - use auto-detected essay type
            document.getElementById('resultStudentName').textContent = studentName;
            const detectedType = result.detectedEssayType ?
                result.detectedEssayType.charAt(0).toUpperCase() + result.detectedEssayType.slice(1).replace('-', ' ') : 'Essay';
            const apIndicator = apStyleEnabled ? ' | AP Style' : '';
            const metaText = ` | ${gradeLevel}th Grade | ${detectedType}${apIndicator} | ${new Date().toLocaleDateString()}`;
            document.getElementById('resultMeta').textContent = metaText;
            document.getElementById('printMeta').textContent = `${studentName}${metaText}`;

            // Handle score grid layout
            const scoreGrid = document.getElementById('scoreGrid');
            const apScoreCard = document.getElementById('apScoreCard');
            const apFeedbackSection = document.getElementById('apFeedbackSection');
            const apLegend = document.getElementById('apLegend');

            if (apStyleEnabled && result.apStyle) {
                scoreGrid.classList.add('four-cols');
                apScoreCard.style.display = 'block';
                apFeedbackSection.style.display = 'block';
                apLegend.style.display = 'flex';
                updateScore('apStyle', result.apStyle.score);

                let apFeedback = result.apStyle.feedback || [];
                if (result.apStyle.corrections && result.apStyle.corrections.length > 0) {
                    const corrections = result.apStyle.corrections
                        .map(c => `"${c.original}" ‚Üí "${c.correction}"`)
                        .join('; ');
                    apFeedback = [...apFeedback, `AP Style corrections: ${corrections}`];
                }
                displayFeedback('apStyleFeedback', apFeedback);
            } else {
                scoreGrid.classList.remove('four-cols');
                apScoreCard.style.display = 'none';
                apFeedbackSection.style.display = 'none';
                apLegend.style.display = 'none';
            }

            // Scores
            updateScore('grammar', result.grammar.score);
            updateScore('spelling', result.spelling.score);
            updateScore('originality', result.originality.score);

            // Feedback
            displayFeedback('grammarFeedback', result.grammar.feedback);

            let spellingFeedback = result.spelling.feedback || [];
            if (result.spelling.corrections && result.spelling.corrections.length > 0) {
                const corrections = result.spelling.corrections
                    .map(c => `"${c.original}" ‚Üí "${c.correction}"`)
                    .join(', ');
                spellingFeedback = [...spellingFeedback, `Corrections: ${corrections}`];
            }
            displayFeedback('spellingFeedback', spellingFeedback);
            displayFeedback('originalityFeedback', result.originality.feedback);

            // Strengths and Improvements
            displayFeedback('strengthsFeedback', result.strengths || ['Good effort on completing the assignment']);
            displayFeedback('improvementFeedback', result.improvements || ['Continue practicing writing skills']);

            // Auto-Detected Essay Type, Tone, and Grade Level
            const detectedInfo = document.getElementById('detectedInfo');
            if (result.detectedEssayType || result.detectedTone || result.detectedGradeLevel) {
                detectedInfo.style.display = 'block';

                // Display detected grade level with i-Ready assessment info
                if (result.detectedGradeLevel) {
                    const gradeLevelEl = document.getElementById('detectedGradeLevel');
                    const level = result.detectedGradeLevel.level;
                    const confidence = result.detectedGradeLevel.confidence || 'medium';
                    const confidenceLabel = confidence === 'high' ? '‚úì' : confidence === 'low' ? '?' : '';
                    gradeLevelEl.textContent = `${level}th Grade ${confidenceLabel}`;
                    gradeLevelEl.title = `i-Ready Assessment: ${confidence} confidence`;

                    // Show reasoning if available
                    const reasoningEl = document.getElementById('gradeLevelReasoning');
                    if (result.detectedGradeLevel.reasoning) {
                        reasoningEl.style.display = 'block';
                        reasoningEl.textContent = `üìä i-Ready Assessment: ${result.detectedGradeLevel.reasoning}`;
                    } else {
                        reasoningEl.style.display = 'none';
                    }
                } else {
                    document.getElementById('detectedGradeLevel').textContent = `${gradeLevel}th Grade`;
                    document.getElementById('gradeLevelReasoning').style.display = 'none';
                }

                document.getElementById('detectedType').textContent = result.detectedEssayType ?
                    result.detectedEssayType.charAt(0).toUpperCase() + result.detectedEssayType.slice(1).replace('-', ' ') : '-';
                document.getElementById('detectedTone').textContent = result.detectedTone ?
                    result.detectedTone.charAt(0).toUpperCase() + result.detectedTone.slice(1) : '-';
            } else {
                detectedInfo.style.display = 'none';
            }

            // AI Detection
            const aiAlert = document.getElementById('aiAlert');
            const aiIcon = document.getElementById('aiAlertIcon');
            const aiTitle = document.getElementById('aiAlertTitle');
            const aiText = document.getElementById('aiAlertText');
            const aiRedFlags = document.getElementById('aiRedFlags');
            const redFlagsList = document.getElementById('redFlagsList');
            const aiExcerpts = document.getElementById('aiExcerpts');
            const excerptsList = document.getElementById('excerptsList');

            aiAlert.classList.remove('warning', 'danger', 'safe');
            aiAlert.classList.add('visible');

            if (result.aiDetection.likelihood === 'high') {
                aiAlert.classList.add('danger');
                aiIcon.textContent = 'üö®';
                aiTitle.textContent = `High AI Detection Alert (${result.aiDetection.confidence}% confidence)`;
            } else if (result.aiDetection.likelihood === 'medium') {
                aiAlert.classList.add('warning');
                aiIcon.textContent = '‚ö†Ô∏è';
                aiTitle.textContent = `Moderate AI Detection Warning (${result.aiDetection.confidence}% confidence)`;
            } else {
                aiAlert.classList.add('safe');
                aiIcon.textContent = '‚úÖ';
                aiTitle.textContent = `Low AI Detection (${result.aiDetection.confidence}% confidence)`;
            }
            aiText.textContent = result.aiDetection.reasoning;

            // Display red flags if any
            if (result.aiDetection.redFlags && result.aiDetection.redFlags.length > 0) {
                aiRedFlags.style.display = 'block';
                redFlagsList.innerHTML = result.aiDetection.redFlags.map(flag => `<li>${flag}</li>`).join('');
            } else {
                aiRedFlags.style.display = 'none';
            }

            // Display suspicious excerpts if any
            if (result.aiDetection.suspiciousExcerpts && result.aiDetection.suspiciousExcerpts.length > 0) {
                aiExcerpts.style.display = 'block';
                excerptsList.innerHTML = result.aiDetection.suspiciousExcerpts.map(excerpt => `<li>"${excerpt}"</li>`).join('');
            } else {
                aiExcerpts.style.display = 'none';
            }

            // Overall feedback
            document.getElementById('overallFeedback').textContent = result.overallFeedback;

            // Highlighted essay
            const highlightedEssay = highlightErrors(originalEssayText, result);
            document.getElementById('highlightedEssay').innerHTML = highlightedEssay;

            // Auto-save to student progress tracking
            const saved = saveStudentEssay(studentName, result, originalEssayText, {
                gradeLevel: result.detectedGradeLevel?.level || gradeLevel,
                essayType: result.detectedEssayType || 'unknown'
            });
            if (saved) {
                console.log(`Essay saved to student progress: ${studentName}`);
            }

            // Smooth scroll to results
            setTimeout(() => {
                document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function updateScore(category, score) {
            const scoreClass = score >= 80 ? 'high' : score >= 60 ? 'medium' : 'low';

            const scoreEl = document.getElementById(`${category}Score`);
            scoreEl.textContent = `${score}%`;
            scoreEl.className = `score-value ${scoreClass}`;

            const progressEl = document.getElementById(`${category}Progress`);
            progressEl.style.width = `${score}%`;
            progressEl.className = `progress-fill ${scoreClass}`;
        }

        function displayFeedback(elementId, feedbackList) {
            const el = document.getElementById(elementId);
            if (el && feedbackList) {
                el.innerHTML = feedbackList.map(item => `<li>${item}</li>`).join('');
            }
        }

        function copyHighlightedEssay() {
            const highlightedEl = document.getElementById('highlightedEssay');
            const text = highlightedEl.innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('Essay text copied to clipboard!');
            }).catch(err => {
                showError('Failed to copy: ' + err.message);
            });
        }

        // Toggle collapsible sections
        function toggleSection(sectionId, headerEl) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('collapsed');
            headerEl.classList.toggle('collapsed');
        }

        // Edit mode state
        let editModeEnabled = false;

        function toggleEditMode() {
            editModeEnabled = !editModeEnabled;
            const essayContainer = document.getElementById('highlightedEssay');
            const toolbar = document.getElementById('editorToolbar');
            const btnText = document.getElementById('editModeBtn');
            const apToolbarBtn = document.getElementById('apToolbarBtn');

            if (editModeEnabled) {
                essayContainer.contentEditable = 'true';
                toolbar.style.display = 'flex';
                btnText.textContent = 'üîí Disable Editing';
                // Show AP Style button if AP mode is enabled
                if (apStyleEnabled) {
                    apToolbarBtn.style.display = 'inline-flex';
                }
            } else {
                essayContainer.contentEditable = 'false';
                toolbar.style.display = 'none';
                btnText.textContent = '‚úèÔ∏è Enable Editing';
            }
        }

        // Get selected text and range
        function getSelectedRange() {
            const selection = window.getSelection();
            if (!selection.rangeCount || selection.isCollapsed) {
                return null;
            }

            const range = selection.getRangeAt(0);
            const container = document.getElementById('highlightedEssay');

            // Make sure selection is within the essay container
            if (!container.contains(range.commonAncestorContainer)) {
                return null;
            }

            return range;
        }

        // Mark selected text as spelling error
        function markAsSpelling() {
            const range = getSelectedRange();
            if (!range) {
                alert('Please select some text first.');
                return;
            }

            const selectedText = range.toString();
            const correction = prompt('Enter the correct spelling:', selectedText);

            if (correction !== null && correction !== selectedText) {
                const span = document.createElement('span');
                span.className = 'redline-error redline-spelling';
                span.innerHTML = `<span class="redline-original">${selectedText}</span><span class="redline-correction">${correction}</span>`;

                range.deleteContents();
                range.insertNode(span);

                window.getSelection().removeAllRanges();
            }
        }

        // Mark selected text as grammar error
        function markAsGrammar() {
            const range = getSelectedRange();
            if (!range) {
                alert('Please select some text first.');
                return;
            }

            const selectedText = range.toString();
            const correction = prompt('Enter the grammar correction:', selectedText);

            if (correction !== null && correction !== selectedText) {
                const span = document.createElement('span');
                span.className = 'redline-error redline-grammar';
                span.innerHTML = `<span class="redline-original">${selectedText}</span><span class="redline-correction">${correction}</span>`;

                range.deleteContents();
                range.insertNode(span);

                window.getSelection().removeAllRanges();
            }
        }

        // Mark selected text as AP style error
        function markAsAP() {
            const range = getSelectedRange();
            if (!range) {
                alert('Please select some text first.');
                return;
            }

            const selectedText = range.toString();
            const correction = prompt('Enter the AP style correction:', selectedText);

            if (correction !== null && correction !== selectedText) {
                const span = document.createElement('span');
                span.className = 'redline-error redline-ap';
                span.innerHTML = `<span class="redline-original">${selectedText}</span><span class="redline-correction">${correction}</span>`;

                range.deleteContents();
                range.insertNode(span);

                window.getSelection().removeAllRanges();
            }
        }

        // Add margin comment
        function addComment() {
            const range = getSelectedRange();
            if (!range) {
                alert('Please select some text first or place cursor where you want the comment.');
                return;
            }

            const comment = prompt('Enter your comment:');

            if (comment) {
                const span = document.createElement('span');
                span.className = 'margin-comment';
                span.textContent = comment;

                range.collapse(false); // Move to end of selection
                range.insertNode(span);

                window.getSelection().removeAllRanges();
            }
        }

        // Clear markup from selection
        function clearMarkup() {
            const range = getSelectedRange();
            if (!range) {
                alert('Please select the marked text you want to clear.');
                return;
            }

            const container = range.commonAncestorContainer;

            // Find any redline spans in or around the selection
            let element = container;
            if (container.nodeType === Node.TEXT_NODE) {
                element = container.parentElement;
            }

            // Check if we're inside a redline-error span
            const redlineSpan = element.closest('.redline-error');
            if (redlineSpan) {
                // Get the original text
                const originalSpan = redlineSpan.querySelector('.redline-original');
                const originalText = originalSpan ? originalSpan.textContent : redlineSpan.textContent;

                // Replace the redline span with just the text
                const textNode = document.createTextNode(originalText);
                redlineSpan.parentNode.replaceChild(textNode, redlineSpan);

                window.getSelection().removeAllRanges();
                return;
            }

            // Check if it's a margin comment
            const commentSpan = element.closest('.margin-comment');
            if (commentSpan) {
                commentSpan.remove();
                window.getSelection().removeAllRanges();
                return;
            }

            alert('No markup found in selection. Select text within a red-lined correction or comment to clear it.');
        }

        // ==========================================
        // BATCH GRADING FUNCTIONS
        // ==========================================

        // Batch state
        let batchFiles = [];
        let batchResults = [];
        let batchApStyleEnabled = false;
        let isProcessingBatch = false;

        // Switch between single, batch, and progress mode
        function switchMode(mode) {
            document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.mode-content').forEach(content => content.classList.remove('active'));

            const tabs = document.querySelectorAll('.mode-tab');
            if (mode === 'single') {
                tabs[0].classList.add('active');
                document.getElementById('singleMode').classList.add('active');
            } else if (mode === 'batch') {
                tabs[1].classList.add('active');
                document.getElementById('batchMode').classList.add('active');
            } else if (mode === 'progress') {
                tabs[2].classList.add('active');
                document.getElementById('progressMode').classList.add('active');
                refreshStudentProgressPanel();
            }
        }

        // Toggle AP style for batch
        function toggleBatchAPStyle() {
            batchApStyleEnabled = !batchApStyleEnabled;
            const toggle = document.getElementById('batchApStyleToggle');
            toggle.classList.toggle('active', batchApStyleEnabled);
        }

        // Update temperature display
        function updateTemperatureDisplay() {
            const value = document.getElementById('temperatureSlider').value;
            document.getElementById('temperatureValue').textContent = value;
        }

        // Handle drag and drop
        const batchUploadZone = document.getElementById('batchUploadZone');
        if (batchUploadZone) {
            batchUploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                batchUploadZone.classList.add('dragover');
            });

            batchUploadZone.addEventListener('dragleave', () => {
                batchUploadZone.classList.remove('dragover');
            });

            batchUploadZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                batchUploadZone.classList.remove('dragover');
                const allFiles = Array.from(e.dataTransfer.files);

                // Separate ZIP files from regular files
                const zipFiles = allFiles.filter(f => f.name.toLowerCase().endsWith('.zip'));
                const regularFiles = allFiles.filter(f =>
                    !f.name.toLowerCase().endsWith('.zip') &&
                    (f.name.endsWith('.txt') || f.name.endsWith('.docx') || f.name.endsWith('.pdf'))
                );

                // Add regular files immediately
                if (regularFiles.length > 0) {
                    addBatchFiles(regularFiles);
                }

                // Process ZIP files
                for (const zipFile of zipFiles) {
                    await processZipFile(zipFile);
                }
            });
        }

        // Handle file selection
        async function handleBatchFileSelect(event) {
            const files = Array.from(event.target.files);

            // Separate ZIP files from regular files
            const zipFiles = files.filter(f => f.name.toLowerCase().endsWith('.zip'));
            const regularFiles = files.filter(f => !f.name.toLowerCase().endsWith('.zip'));

            // Add regular files immediately
            if (regularFiles.length > 0) {
                addBatchFiles(regularFiles);
            }

            // Process ZIP files
            for (const zipFile of zipFiles) {
                await processZipFile(zipFile);
            }

            event.target.value = ''; // Reset input
        }

        // Process a ZIP file (Schoology bulk download)
        async function processZipFile(zipFile) {
            const statusEl = document.getElementById('zipProcessingStatus');
            const statusTextEl = document.getElementById('zipStatusText');

            statusEl.style.display = 'block';
            statusTextEl.textContent = `Extracting ${zipFile.name}...`;

            try {
                const zip = await JSZip.loadAsync(zipFile);
                const extractedFiles = [];
                const supportedExtensions = ['.txt', '.docx', '.pdf'];

                // Get all files from the ZIP
                const filePromises = [];
                zip.forEach((relativePath, zipEntry) => {
                    // Skip directories and hidden files
                    if (zipEntry.dir || relativePath.startsWith('__MACOSX') || relativePath.startsWith('.')) {
                        return;
                    }

                    // Check if it's a supported file type
                    const ext = relativePath.toLowerCase().substring(relativePath.lastIndexOf('.'));
                    if (supportedExtensions.includes(ext)) {
                        const fileName = relativePath.split('/').pop(); // Get just the filename without path

                        filePromises.push(
                            zipEntry.async('blob').then(blob => {
                                // Create a File object from the blob
                                const file = new File([blob], fileName, { type: getMimeType(ext) });
                                return file;
                            })
                        );
                    }
                });

                statusTextEl.textContent = `Processing ${filePromises.length} files from ${zipFile.name}...`;

                const files = await Promise.all(filePromises);

                if (files.length === 0) {
                    alert(`No supported essay files (.txt, .docx, .pdf) found in ${zipFile.name}`);
                } else {
                    addBatchFiles(files);
                    statusTextEl.textContent = `‚úì Extracted ${files.length} files from ${zipFile.name}`;
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 2000);
                }

            } catch (error) {
                console.error('ZIP extraction error:', error);
                alert(`Error extracting ZIP file: ${error.message}`);
                statusEl.style.display = 'none';
            }
        }

        // Get MIME type from extension
        function getMimeType(ext) {
            const mimeTypes = {
                '.txt': 'text/plain',
                '.docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                '.pdf': 'application/pdf'
            };
            return mimeTypes[ext] || 'application/octet-stream';
        }

        // Add files to batch list
        function addBatchFiles(files) {
            files.forEach(file => {
                // Check if file already added
                if (!batchFiles.find(f => f.name === file.name)) {
                    batchFiles.push(file);
                }
            });
            renderBatchFileList();
            updateBatchButton();
        }

        // Remove file from batch
        function removeBatchFile(index) {
            batchFiles.splice(index, 1);
            renderBatchFileList();
            updateBatchButton();
        }

        // Clear all batch files
        function clearBatchFiles() {
            batchFiles = [];
            batchResults = [];
            renderBatchFileList();
            updateBatchButton();
            document.getElementById('batchResultsContainer').classList.remove('visible');
            document.getElementById('essayResultsStream').innerHTML = '';
        }

        // Check if filename follows the selected naming convention
        function checkNamingConvention(filename) {
            // Remove file extension
            const nameWithoutExt = filename.replace(/\.(txt|docx|pdf)$/i, '');
            const parts = nameWithoutExt.split('_');
            const pattern = teacherPreferences.naming.pattern || 'firstname_lastname_assignment';
            const patternInfo = NAMING_PATTERNS[pattern];
            const namePattern = /^[A-Z][a-zA-Z]+$/;
            const studentIdPattern = /^\d{4,10}$/;

            switch (pattern) {
                case 'firstname_lastname_assignment':
                    // FirstName_LastName_Assignment - need at least 3 parts
                    if (parts.length < 3) {
                        return { valid: false, reason: `Missing parts (need ${patternInfo.label})` };
                    }
                    if (!namePattern.test(parts[0])) {
                        return { valid: false, reason: 'First name should start with capital letter' };
                    }
                    if (!namePattern.test(parts[1])) {
                        return { valid: false, reason: 'Last name should start with capital letter' };
                    }
                    if (parts.slice(2).join('_').length < 2) {
                        return { valid: false, reason: 'Assignment name too short' };
                    }
                    return {
                        valid: true,
                        firstName: parts[0],
                        lastName: parts[1],
                        assignmentName: parts.slice(2).join('_')
                    };

                case 'lastname_firstname_assignment':
                    // LastName_FirstName_Assignment - need at least 3 parts
                    if (parts.length < 3) {
                        return { valid: false, reason: `Missing parts (need ${patternInfo.label})` };
                    }
                    if (!namePattern.test(parts[0])) {
                        return { valid: false, reason: 'Last name should start with capital letter' };
                    }
                    if (!namePattern.test(parts[1])) {
                        return { valid: false, reason: 'First name should start with capital letter' };
                    }
                    if (parts.slice(2).join('_').length < 2) {
                        return { valid: false, reason: 'Assignment name too short' };
                    }
                    return {
                        valid: true,
                        firstName: parts[1],
                        lastName: parts[0],
                        assignmentName: parts.slice(2).join('_')
                    };

                case 'studentid_assignment':
                    // StudentID_Assignment - need at least 2 parts
                    if (parts.length < 2) {
                        return { valid: false, reason: `Missing parts (need ${patternInfo.label})` };
                    }
                    if (!studentIdPattern.test(parts[0])) {
                        return { valid: false, reason: 'Student ID should be 4-10 digits' };
                    }
                    if (parts.slice(1).join('_').length < 2) {
                        return { valid: false, reason: 'Assignment name too short' };
                    }
                    return {
                        valid: true,
                        studentId: parts[0],
                        assignmentName: parts.slice(1).join('_')
                    };

                case 'lastname_assignment':
                    // LastName_Assignment - need at least 2 parts
                    if (parts.length < 2) {
                        return { valid: false, reason: `Missing parts (need ${patternInfo.label})` };
                    }
                    if (!namePattern.test(parts[0])) {
                        return { valid: false, reason: 'Last name should start with capital letter' };
                    }
                    if (parts.slice(1).join('_').length < 2) {
                        return { valid: false, reason: 'Assignment name too short' };
                    }
                    return {
                        valid: true,
                        lastName: parts[0],
                        assignmentName: parts.slice(1).join('_')
                    };

                case 'firstname_lastname':
                    // FirstName_LastName - need at least 2 parts (no assignment required)
                    if (parts.length < 2) {
                        return { valid: false, reason: `Missing parts (need ${patternInfo.label})` };
                    }
                    if (!namePattern.test(parts[0])) {
                        return { valid: false, reason: 'First name should start with capital letter' };
                    }
                    if (!namePattern.test(parts[1])) {
                        return { valid: false, reason: 'Last name should start with capital letter' };
                    }
                    return {
                        valid: true,
                        firstName: parts[0],
                        lastName: parts[1],
                        assignmentName: parts.length > 2 ? parts.slice(2).join('_') : null
                    };

                case 'any_underscore':
                    // Any format with at least one underscore
                    if (parts.length < 2) {
                        return { valid: false, reason: 'Need at least one underscore separator' };
                    }
                    return {
                        valid: true,
                        rawName: nameWithoutExt
                    };

                default:
                    // Fallback to original FirstName_LastName_Assignment pattern
                    if (parts.length < 3) {
                        return { valid: false, reason: 'Missing parts (need FirstName_LastName_Assignment)' };
                    }
                    return {
                        valid: true,
                        firstName: parts[0],
                        lastName: parts[1],
                        assignmentName: parts.slice(2).join('_')
                    };
            }
        }

        // Render file list
        function renderBatchFileList() {
            const listEl = document.getElementById('batchFileList');
            if (batchFiles.length === 0) {
                listEl.innerHTML = '';
                document.getElementById('clearBatchBtn').style.display = 'none';
                return;
            }

            const penalty = teacherPreferences.naming.penalty || 10;

            document.getElementById('clearBatchBtn').style.display = 'inline-flex';
            listEl.innerHTML = batchFiles.map((file, index) => {
                const namingCheck = checkNamingConvention(file.name);

                // Build student display name based on available fields
                let studentName = '';
                if (namingCheck.valid) {
                    if (namingCheck.firstName && namingCheck.lastName) {
                        studentName = `${namingCheck.firstName} ${namingCheck.lastName}`;
                    } else if (namingCheck.lastName) {
                        studentName = namingCheck.lastName;
                    } else if (namingCheck.studentId) {
                        studentName = `Student #${namingCheck.studentId}`;
                    } else if (namingCheck.rawName) {
                        studentName = namingCheck.rawName.split('_')[0];
                    }
                } else {
                    studentName = extractStudentName(file.name);
                }
                const assignmentName = namingCheck.valid ? namingCheck.assignmentName : null;

                return `
                    <div class="batch-file-item ${!namingCheck.valid ? 'naming-violation' : ''}">
                        <div class="file-info">
                            <span>${namingCheck.valid ? 'üìÑ' : '‚ö†Ô∏è'}</span>
                            <span>${file.name}</span>
                            ${studentName ? `<span style="color: var(--gray-500);">(${studentName}${assignmentName ? ' - ' + assignmentName : ''})</span>` : ''}
                            ${!namingCheck.valid ? `<span class="naming-warning">-${penalty} pts: ${namingCheck.reason}</span>` : ''}
                        </div>
                        <button class="remove-btn" onclick="removeBatchFile(${index})">‚úï</button>
                    </div>
                `;
            }).join('');
        }

        // Update batch button state
        function updateBatchButton() {
            const btn = document.getElementById('batchGradeBtn');
            const count = document.getElementById('batchCount');
            count.textContent = batchFiles.length;
            btn.disabled = batchFiles.length === 0 || isProcessingBatch;
        }

        // Show batch error
        function showBatchError(message) {
            const errorEl = document.getElementById('batchErrorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('visible');
            setTimeout(() => errorEl.classList.remove('visible'), 5000);
        }

        // Start batch grading
        async function startBatchGrading() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showBatchError('Please enter an API key in the API Configuration section.');
                return;
            }

            if (batchFiles.length === 0) {
                showBatchError('Please add at least one essay file.');
                return;
            }

            isProcessingBatch = true;
            batchResults = [];
            updateBatchButton();

            // Show queue status
            document.getElementById('queueStatus').style.display = 'block';
            document.getElementById('batchResultsContainer').classList.add('visible');
            document.getElementById('essayResultsStream').innerHTML = '';

            // Grade level is now auto-detected via i-Ready assessment or overridden in preferences
            const gradeLevelOverride = teacherPreferences.gradeLevel?.override;
            const gradeLevel = gradeLevelOverride ? teacherPreferences.gradeLevel?.value || '8' : null;
            const temperature = parseFloat(document.getElementById('temperatureSlider').value);
            const provider = document.getElementById('apiProvider').value;

            // Process each file
            for (let i = 0; i < batchFiles.length; i++) {
                const file = batchFiles[i];

                // Check naming convention
                const namingCheck = checkNamingConvention(file.name);
                const studentName = namingCheck.valid
                    ? `${namingCheck.firstName} ${namingCheck.lastName}`
                    : (extractStudentName(file.name) || `Student ${i + 1}`);
                const assignmentName = namingCheck.valid ? namingCheck.assignmentName : null;
                const namingViolation = !namingCheck.valid;

                // Update queue status
                document.getElementById('queueCurrentName').textContent = studentName;
                document.getElementById('queueCount').textContent = `${i + 1}/${batchFiles.length}`;
                document.getElementById('queueProgressFill').style.width = `${((i) / batchFiles.length) * 100}%`;
                document.getElementById('queueText').textContent = `Grading essay ${i + 1} of ${batchFiles.length}...`;

                // Create placeholder card
                const cardId = `essay-card-${i}`;
                createEssayCard(cardId, studentName, 'processing');

                try {
                    // Read file content
                    const essayText = await readFileContent(file);

                    if (essayText.trim().split(/\s+/).length < 20) {
                        throw new Error('Essay too short (less than 20 words)');
                    }

                    // Grade the essay
                    let result = await gradeEssayAPI(essayText, studentName, gradeLevel, temperature, provider, batchApStyleEnabled);

                    // Apply all preference-based penalties
                    result = applyPreferencePenalties(result, essayText, namingViolation);

                    // Add naming violation details if applicable
                    if (namingViolation && teacherPreferences.naming.enabled) {
                        result.namingViolation = {
                            penalty: teacherPreferences.naming.penalty,
                            reason: namingCheck.reason
                        };
                    }
                    result.assignmentName = assignmentName;

                    // Get detected grade level from result or use override
                    const detectedGradeLevel = result.detectedGradeLevel?.level || gradeLevel || '8';

                    // Store result
                    batchResults.push({
                        studentName,
                        essayText,
                        result,
                        gradeLevel: detectedGradeLevel,
                        filename: file.name,
                        namingViolation: !namingCheck.valid
                    });

                    // Auto-save to student progress tracking
                    saveStudentEssay(studentName, result, essayText, {
                        gradeLevel: detectedGradeLevel,
                        essayType: result.detectedEssayType || 'unknown',
                        filename: file.name
                    });

                    // Update card with results
                    updateEssayCard(cardId, studentName, essayText, result, detectedGradeLevel, i);

                } catch (error) {
                    console.error(`Error grading ${file.name}:`, error);
                    batchResults.push({
                        studentName,
                        error: error.message,
                        filename: file.name
                    });
                    updateEssayCardError(cardId, studentName, error.message);
                }

                // Small delay between API calls to avoid rate limiting
                if (i < batchFiles.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            // Complete
            document.getElementById('queueProgressFill').style.width = '100%';
            document.getElementById('queueText').textContent = 'All essays graded!';
            document.getElementById('queueCurrentName').textContent = 'Complete';

            // Update summary
            updateClassSummary();

            isProcessingBatch = false;
            updateBatchButton();

            // Hide queue status after a moment
            setTimeout(() => {
                document.getElementById('queueStatus').style.display = 'none';
            }, 2000);
        }

        // Read file content
        async function readFileContent(file) {
            if (file.name.toLowerCase().endsWith('.txt')) {
                return await file.text();
            } else if (file.name.toLowerCase().endsWith('.docx')) {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                return result.value;
            } else if (file.name.toLowerCase().endsWith('.pdf')) {
                const arrayBuffer = await file.arrayBuffer();
                return await extractTextFromPDF(arrayBuffer);
            }
            throw new Error('Unsupported file type');
        }

        // Grade essay via API (shared function)
        async function gradeEssayAPI(essayText, studentName, gradeLevel, temperature, provider, useAPStyle) {
            const apiKey = document.getElementById('apiKey').value.trim();

            // Check if grade level override is enabled in preferences
            const gradeLevelOverride = teacherPreferences.gradeLevel?.override;
            const forcedGradeLevel = teacherPreferences.gradeLevel?.value || '8';

            // Determine grade level instruction
            const gradeLevelInstruction = gradeLevelOverride
                ? `The teacher has specified this is a ${forcedGradeLevel}th grade student. Grade accordingly.`
                : `FIRST, analyze the essay using i-Ready Reading and Writing assessment metrics to determine the student's actual writing grade level (6-12). Then grade the essay according to that detected level.`;

            // Build AP Style section if enabled
            const apStyleSection = useAPStyle ? `
    "apStyle": {
        "score": <number 0-100>,
        "feedback": ["<specific AP style feedback>"],
        "corrections": [{"original": "<text>", "correction": "<corrected>"}]
    },` : '';

            const apStyleGuidelines = useAPStyle ? `
- AP Style: Evaluate adherence to Associated Press style guidelines` : '';

            const prompt = `You are an expert English teacher (grades 6-12) assessing a student's essay.

IMPORTANT: The student's name is "${studentName}". Always refer to them by this name.${useAPStyle ? ' Also evaluate for AP style compliance.' : ''}

${gradeLevelInstruction}

ESSAY TO ANALYZE:
"""
${essayText}
"""

Provide your assessment in the following JSON format ONLY (no additional text):
{
    "grammar": {
        "score": <number 0-100>,
        "feedback": ["<specific feedback>"],
        "corrections": [{"original": "<text>", "correction": "<corrected>"}]
    },
    "spelling": {
        "score": <number 0-100>,
        "feedback": ["<specific feedback>"],
        "corrections": [{"original": "<misspelled>", "correction": "<correct>"}]
    },
    "originality": {
        "score": <number 0-100>,
        "feedback": ["<specific feedback>"]
    },${apStyleSection}
    "aiDetection": {
        "likelihood": "<low|medium|high>",
        "confidence": <number 0-100>,
        "reasoning": "<brief explanation>",
        "redFlags": ["<specific telltale sign>"],
        "suspiciousExcerpts": ["<exact quote>"]
    },
    "skillGaps": {
        "grammar": [
            {"skill": "<specific grammar skill name>", "severity": "<minor|moderate|significant>", "instances": <count>, "examples": ["<example from essay>"]}
        ],
        "mechanics": [
            {"skill": "<punctuation, capitalization, etc>", "severity": "<minor|moderate|significant>", "instances": <count>, "examples": ["<example>"]}
        ],
        "organization": [
            {"skill": "<thesis, topic sentences, transitions, etc>", "severity": "<minor|moderate|significant>", "description": "<what's missing or weak>"}
        ],
        "development": [
            {"skill": "<evidence, elaboration, analysis, etc>", "severity": "<minor|moderate|significant>", "description": "<what's missing or weak>"}
        ],
        "vocabulary": [
            {"skill": "<word choice, variety, academic language>", "severity": "<minor|moderate|significant>", "description": "<what's needed>"}
        ],
        "priority": ["<top 3 skills to work on in order of importance>"]
    },
    "detectedEssayType": "<narrative|persuasive|expository|descriptive|argumentative|compare-contrast|cause-effect|personal>",
    "detectedTone": "<formal|informal|academic|conversational|emotional|objective|persuasive|reflective>",
    "strengths": ["<strength>"],
    "improvements": ["<area to improve>"],
    "overallFeedback": "<2-3 sentences of encouraging feedback for ${studentName}>",
    "detectedGradeLevel": {
        "level": <number 6-12 representing the detected writing level>,
        "confidence": "<low|medium|high>",
        "reasoning": "<brief i-Ready assessment explanation>"
    }
}

SKILL GAP CATEGORIES TO ANALYZE:
Grammar: subject-verb agreement, pronoun reference, verb tense consistency, sentence fragments, run-on sentences, comma splices, parallel structure, modifier placement
Mechanics: comma usage, semicolon/colon usage, apostrophes, quotation marks, capitalization
Organization: thesis statement, topic sentences, transitions, paragraph unity, logical flow, introduction, conclusion
Development: supporting evidence, elaboration, examples, analysis, counterarguments (for argumentative)
Vocabulary: word choice precision, vocabulary variety, academic language, avoiding repetition

i-READY GRADE LEVEL INDICATORS:
- Grade 6: Simple sentences, basic transitions, ~12K word vocabulary
- Grade 7: Compound sentences, varied transitions, domain-specific terms
- Grade 8: Complex sentences, sophisticated transitions, academic vocabulary
- Grade 9-10: Varied syntax for effect, nuanced transitions, arguable thesis
- Grade 11-12: Sophisticated syntax, seamless transitions, advanced vocabulary

AI DETECTION - Look for these telltale signs (considering detected grade level):
1. EM-DASHES (‚Äî): Suspicious for students below 10th grade
2. CLICH√â OPENERS: "In today's world", "Throughout history"
3. TRANSITION OVERUSE: "Furthermore", "Moreover", "Additionally"
4. VOCABULARY MISMATCH: Words too advanced for the grade level
5. PERFECT STRUCTURE: Unnaturally perfect 5-paragraph structure
6. HEDGING PHRASES: "It could be argued", "One might say"${apStyleGuidelines}

Return ONLY valid JSON.`;

            if (provider === 'anthropic') {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 3000,
                        temperature: temperature,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API request failed');
                }

                const data = await response.json();
                return parseJSONResponse(data.content[0].text);
            } else {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        max_tokens: 3000,
                        temperature: temperature,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API request failed');
                }

                const data = await response.json();
                return parseJSONResponse(data.choices[0].message.content);
            }
        }

        // Parse JSON response, stripping markdown code fences if present
        function parseJSONResponse(text) {
            let cleanText = text.trim();

            // Remove markdown code fences if present (```json ... ``` or ``` ... ```)
            if (cleanText.startsWith('```')) {
                // Find the end of the first line (could be ```json or just ```)
                const firstNewline = cleanText.indexOf('\n');
                if (firstNewline !== -1) {
                    cleanText = cleanText.substring(firstNewline + 1);
                }
                // Remove closing ```
                if (cleanText.endsWith('```')) {
                    cleanText = cleanText.slice(0, -3).trim();
                }
            }

            return JSON.parse(cleanText);
        }

        // Create essay card placeholder
        function createEssayCard(cardId, studentName, status) {
            const stream = document.getElementById('essayResultsStream');
            const html = `
                <div class="essay-result-card ${status}" id="${cardId}">
                    <div class="essay-card-header">
                        <div class="essay-card-student">
                            <span class="student-name">${studentName}</span>
                            <span class="student-meta">Processing...</span>
                        </div>
                        <div class="essay-card-scores">
                            <div class="spinner" style="width: 20px; height: 20px;"></div>
                        </div>
                    </div>
                </div>
            `;
            stream.insertAdjacentHTML('beforeend', html);
        }

        // Update essay card with results
        function updateEssayCard(cardId, studentName, essayText, result, gradeLevel, index) {
            const card = document.getElementById(cardId);
            if (!card) return;

            const getScoreClass = (score) => score >= 80 ? 'high' : score >= 60 ? 'medium' : 'low';
            const detectedType = result.detectedEssayType ?
                result.detectedEssayType.charAt(0).toUpperCase() + result.detectedEssayType.slice(1).replace('-', ' ') : 'Essay';

            const highlightedEssay = highlightErrors(essayText, result);

            const hasPenalties = result.appliedPenalties && result.appliedPenalties.length > 0;
            card.className = 'essay-result-card' + (hasPenalties ? ' naming-penalty' : '');

            // Build penalty badges HTML
            let penaltyBadgesHtml = '';
            if (result.appliedPenalties) {
                penaltyBadgesHtml = result.appliedPenalties.map(p =>
                    `<span class="naming-penalty-badge">-${p.amount} pts: ${p.type === 'naming' ? 'Naming' : p.type === 'ai' ? 'AI' : p.type === 'wordCount' ? 'Words' : p.type}</span>`
                ).join('');
            }

            // Build grade level display with i-Ready indicator
            const gradeLevelDisplay = result.detectedGradeLevel
                ? `<span title="i-Ready Assessment: ${result.detectedGradeLevel.reasoning || 'Auto-detected'}">${gradeLevel}th Grade <span style="font-size: 0.625rem; background: var(--primary); color: white; padding: 0.125rem 0.25rem; border-radius: 3px; margin-left: 0.25rem;">i-Ready</span></span>`
                : `${gradeLevel}th Grade`;

            card.innerHTML = `
                <div class="essay-card-header" onclick="toggleEssayCard('${cardId}')">
                    <div class="essay-card-student">
                        <span class="student-name">${studentName}</span>
                        <span class="student-meta">${gradeLevelDisplay} ‚Ä¢ ${detectedType}${result.assignmentName ? ' ‚Ä¢ ' + result.assignmentName : ''}</span>
                        ${penaltyBadgesHtml}
                    </div>
                    <div class="essay-card-scores">
                        <div class="mini-score">
                            <div class="score-num ${getScoreClass(result.grammar.score)}">${result.grammar.score}</div>
                            <div class="score-cat">Grammar</div>
                        </div>
                        <div class="mini-score">
                            <div class="score-num ${getScoreClass(result.spelling.score)}">${result.spelling.score}</div>
                            <div class="score-cat">Spelling</div>
                        </div>
                        <div class="mini-score">
                            <div class="score-num ${getScoreClass(result.originality.score)}">${result.originality.score}</div>
                            <div class="score-cat">Original</div>
                        </div>
                        <div class="ai-indicator ${result.aiDetection.likelihood}">
                            ${result.aiDetection.likelihood === 'high' ? 'üö®' : result.aiDetection.likelihood === 'medium' ? '‚ö†Ô∏è' : '‚úÖ'}
                            AI: ${result.aiDetection.likelihood}
                        </div>
                        <span class="essay-card-toggle">‚ñº</span>
                    </div>
                </div>
                <div class="essay-card-body" id="${cardId}-body">
                    ${result.appliedPenalties && result.appliedPenalties.length > 0 ? `
                    <div style="background: #fef2f2; border: 1px solid #fecaca; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
                        <strong style="color: #991b1b;">‚ö†Ô∏è Penalties Applied</strong>
                        <ul style="margin: 0.5rem 0 0; padding-left: 1.25rem; font-size: 0.8125rem; color: #7f1d1d;">
                            ${result.appliedPenalties.map(p => `<li><strong>-${p.amount} points:</strong> ${p.reason}</li>`).join('')}
                        </ul>
                        ${result.namingViolation ? `<p style="margin: 0.5rem 0 0; font-size: 0.75rem; color: #7f1d1d;">Expected naming format: <code style="background: rgba(0,0,0,0.05); padding: 0.125rem 0.25rem; border-radius: 3px;">${getCurrentNamingPattern().label}.docx</code></p>` : ''}
                    </div>
                    ` : ''}

                    <!-- Detailed Feedback -->
                    <div style="margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">üìã Overall Assessment</h4>
                        <p style="color: var(--gray-700);">${result.overallFeedback}</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <h5 style="color: var(--success); margin-bottom: 0.25rem;">‚úÖ Strengths</h5>
                            <ul style="font-size: 0.875rem; padding-left: 1.25rem; margin: 0;">
                                ${(result.strengths || []).map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                        <div>
                            <h5 style="color: var(--warning); margin-bottom: 0.25rem;">üéØ Areas to Improve</h5>
                            <ul style="font-size: 0.875rem; padding-left: 1.25rem; margin: 0;">
                                ${(result.improvements || []).map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    ${result.aiDetection.redFlags && result.aiDetection.redFlags.length > 0 ? `
                    <div style="background: #fee2e2; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
                        <strong style="color: #991b1b;">üö© AI Red Flags:</strong>
                        <ul style="margin: 0.25rem 0 0 1.25rem; font-size: 0.8125rem;">
                            ${result.aiDetection.redFlags.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}

                    <!-- Skill Gaps Analysis -->
                    ${result.skillGaps ? `
                    <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #bae6fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h4 style="color: #0369a1; margin: 0;">üéØ Skill Gaps Analysis</h4>
                            <button class="btn btn-primary" style="padding: 0.375rem 0.75rem; font-size: 0.8125rem;" onclick="generatePractice('${studentName}', ${index})">
                                üìù Generate Practice
                            </button>
                        </div>

                        ${result.skillGaps.priority && result.skillGaps.priority.length > 0 ? `
                        <div style="margin-bottom: 0.75rem; padding: 0.5rem; background: white; border-radius: 6px;">
                            <strong style="color: #0369a1; font-size: 0.875rem;">Priority Focus Areas:</strong>
                            <ol style="margin: 0.25rem 0 0 1.25rem; font-size: 0.8125rem; color: var(--gray-700);">
                                ${result.skillGaps.priority.map(p => `<li>${p}</li>`).join('')}
                            </ol>
                        </div>
                        ` : ''}

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.8125rem;">
                            ${result.skillGaps.grammar && result.skillGaps.grammar.length > 0 ? `
                            <div style="background: white; padding: 0.5rem; border-radius: 6px;">
                                <strong style="color: #dc2626;">Grammar:</strong>
                                <ul style="margin: 0.25rem 0 0 1rem; padding: 0;">
                                    ${result.skillGaps.grammar.slice(0, 3).map(g => `<li>${g.skill} <span style="color: ${g.severity === 'significant' ? '#dc2626' : g.severity === 'moderate' ? '#f59e0b' : '#6b7280'};">(${g.instances || 1}x)</span></li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}

                            ${result.skillGaps.mechanics && result.skillGaps.mechanics.length > 0 ? `
                            <div style="background: white; padding: 0.5rem; border-radius: 6px;">
                                <strong style="color: #7c3aed;">Mechanics:</strong>
                                <ul style="margin: 0.25rem 0 0 1rem; padding: 0;">
                                    ${result.skillGaps.mechanics.slice(0, 3).map(m => `<li>${m.skill}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}

                            ${result.skillGaps.organization && result.skillGaps.organization.length > 0 ? `
                            <div style="background: white; padding: 0.5rem; border-radius: 6px;">
                                <strong style="color: #0891b2;">Organization:</strong>
                                <ul style="margin: 0.25rem 0 0 1rem; padding: 0;">
                                    ${result.skillGaps.organization.slice(0, 3).map(o => `<li>${o.skill}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}

                            ${result.skillGaps.development && result.skillGaps.development.length > 0 ? `
                            <div style="background: white; padding: 0.5rem; border-radius: 6px;">
                                <strong style="color: #059669;">Development:</strong>
                                <ul style="margin: 0.25rem 0 0 1rem; padding: 0;">
                                    ${result.skillGaps.development.slice(0, 3).map(d => `<li>${d.skill}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}

                            ${result.skillGaps.vocabulary && result.skillGaps.vocabulary.length > 0 ? `
                            <div style="background: white; padding: 0.5rem; border-radius: 6px;">
                                <strong style="color: #ca8a04;">Vocabulary:</strong>
                                <ul style="margin: 0.25rem 0 0 1rem; padding: 0;">
                                    ${result.skillGaps.vocabulary.slice(0, 3).map(v => `<li>${v.skill}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Redlined Essay -->
                    <div style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h4>üìÑ Redlined Essay</h4>
                            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="toggleBatchEditMode('${cardId}')">
                                <span id="${cardId}-edit-btn">‚úèÔ∏è Edit</span>
                            </button>
                        </div>
                        <div class="highlighted-essay-container" id="${cardId}-essay" style="max-height: 300px;">
                            ${highlightedEssay}
                        </div>
                    </div>

                    <div class="essay-card-actions">
                        <button class="btn btn-secondary" onclick="printIndividualEssay('${cardId}', '${studentName}', '${gradeLevel}')">üñ®Ô∏è Print Report</button>
                        <button class="btn btn-secondary" onclick="downloadIndividualEssay(${index})">üíæ Download HTML</button>
                        <button class="btn btn-secondary" onclick="copyEssayText('${cardId}')">üìã Copy Text</button>
                    </div>
                </div>
            `;
        }

        // Update card with error
        function updateEssayCardError(cardId, studentName, errorMsg) {
            const card = document.getElementById(cardId);
            if (!card) return;

            card.className = 'essay-result-card error';
            card.innerHTML = `
                <div class="essay-card-header">
                    <div class="essay-card-student">
                        <span class="student-name">${studentName}</span>
                        <span class="student-meta" style="color: var(--danger);">Error</span>
                    </div>
                    <div class="essay-card-scores">
                        <span style="color: var(--danger);">‚ùå ${errorMsg}</span>
                    </div>
                </div>
            `;
        }

        // Toggle essay card expand/collapse
        function toggleEssayCard(cardId) {
            const header = document.querySelector(`#${cardId} .essay-card-header`);
            const body = document.getElementById(`${cardId}-body`);

            if (header && body) {
                header.classList.toggle('expanded');
                body.classList.toggle('expanded');
            }
        }

        // Toggle edit mode for batch essay
        function toggleBatchEditMode(cardId) {
            const essayContainer = document.getElementById(`${cardId}-essay`);
            const btnText = document.getElementById(`${cardId}-edit-btn`);

            if (essayContainer.contentEditable === 'true') {
                essayContainer.contentEditable = 'false';
                essayContainer.style.border = '';
                btnText.textContent = '‚úèÔ∏è Edit';
            } else {
                essayContainer.contentEditable = 'true';
                essayContainer.style.border = '2px solid var(--primary)';
                btnText.textContent = 'üîí Done';
            }
        }

        // Print individual essay
        function printIndividualEssay(cardId, studentName, gradeLevel) {
            const essayContainer = document.getElementById(`${cardId}-essay`);
            const cardBody = document.getElementById(`${cardId}-body`);

            if (!cardBody) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Essay Report - ${studentName}</title>
                    <style>
                        body { font-family: Georgia, serif; padding: 2rem; max-width: 800px; margin: 0 auto; }
                        h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
                        .meta { color: #666; margin-bottom: 1.5rem; }
                        .redline-original { color: #dc2626; text-decoration: line-through; }
                        .redline-correction { color: #dc2626; font-weight: bold; }
                        .redline-correction::before { content: '['; }
                        .redline-correction::after { content: ']'; }
                        .redline-spelling .redline-original { text-decoration-style: wavy; }
                        .margin-comment { background: #fef3c7; border-left: 3px solid #dc2626; padding: 2px 6px; font-size: 0.75rem; }
                        h4 { margin-top: 1.5rem; margin-bottom: 0.5rem; }
                        ul { margin: 0; padding-left: 1.5rem; }
                        .essay-box { border: 1px solid #ccc; padding: 1rem; margin-top: 1rem; line-height: 2; }
                    </style>
                </head>
                <body>
                    <h1>Essay Assessment Report</h1>
                    <div class="meta">${studentName} | ${gradeLevel}th Grade | ${new Date().toLocaleDateString()}</div>
                    ${cardBody.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Download individual essay as HTML
        function downloadIndividualEssay(index) {
            if (!batchResults[index] || batchResults[index].error) return;

            const { studentName, essayText, result, gradeLevel } = batchResults[index];
            const highlightedEssay = highlightErrors(essayText, result);

            const html = `<!DOCTYPE html>
<html>
<head>
    <title>Essay Report - ${studentName}</title>
    <style>
        body { font-family: Georgia, serif; padding: 2rem; max-width: 800px; margin: 0 auto; line-height: 1.6; }
        h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .meta { color: #666; margin-bottom: 1.5rem; font-size: 0.9rem; }
        .scores { display: flex; gap: 2rem; margin-bottom: 1.5rem; }
        .score { text-align: center; }
        .score-value { font-size: 1.5rem; font-weight: bold; }
        .score-value.high { color: #059669; }
        .score-value.medium { color: #d97706; }
        .score-value.low { color: #dc2626; }
        .score-label { font-size: 0.75rem; color: #666; }
        .section { margin-bottom: 1.5rem; }
        .section h3 { margin-bottom: 0.5rem; font-size: 1rem; }
        ul { margin: 0; padding-left: 1.5rem; }
        .essay-box { border: 1px solid #ccc; padding: 1.5rem; margin-top: 1rem; line-height: 2.2; font-family: Georgia, serif; }
        .redline-original { color: #dc2626; text-decoration: line-through; text-decoration-thickness: 2px; }
        .redline-correction { color: #dc2626; font-weight: 600; }
        .redline-correction::before { content: '['; }
        .redline-correction::after { content: ']'; }
        .redline-spelling .redline-original { text-decoration-style: wavy; }
        .margin-comment { background: #fef3c7; border-left: 3px solid #dc2626; padding: 2px 6px; font-size: 0.75rem; margin-left: 8px; }
        .ai-alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .ai-alert.low { background: #d1fae5; border: 1px solid #059669; }
        .ai-alert.medium { background: #fef3c7; border: 1px solid #d97706; }
        .ai-alert.high { background: #fee2e2; border: 1px solid #dc2626; }
        .naming-alert { background: #fef2f2; border: 1px solid #dc2626; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        @media print { body { padding: 0; } }
    </style>
</head>
<body>
    <h1>Essay Assessment Report</h1>
    <div class="meta">
        <strong>${studentName}</strong> | ${gradeLevel}th Grade |
        ${result.detectedEssayType ? result.detectedEssayType.charAt(0).toUpperCase() + result.detectedEssayType.slice(1) : 'Essay'}${result.assignmentName ? ' | ' + result.assignmentName : ''} |
        ${new Date().toLocaleDateString()}
    </div>

    ${result.appliedPenalties && result.appliedPenalties.length > 0 ? `
    <div class="naming-alert">
        <strong>‚ö†Ô∏è Penalties Applied</strong>
        <ul style="margin: 0.5rem 0 0; padding-left: 1.25rem;">
            ${result.appliedPenalties.map(p => `<li><strong>-${p.amount} points:</strong> ${p.reason}</li>`).join('')}
        </ul>
        ${result.namingViolation ? `<div style="margin-top: 0.5rem; font-size: 0.875rem;">Expected naming format: ${getCurrentNamingPattern().label}.docx</div>` : ''}
    </div>
    ` : ''}

    <div class="scores">
        <div class="score">
            <div class="score-value ${result.grammar.score >= 80 ? 'high' : result.grammar.score >= 60 ? 'medium' : 'low'}">${result.grammar.score}%</div>
            <div class="score-label">Grammar</div>
        </div>
        <div class="score">
            <div class="score-value ${result.spelling.score >= 80 ? 'high' : result.spelling.score >= 60 ? 'medium' : 'low'}">${result.spelling.score}%</div>
            <div class="score-label">Spelling</div>
        </div>
        <div class="score">
            <div class="score-value ${result.originality.score >= 80 ? 'high' : result.originality.score >= 60 ? 'medium' : 'low'}">${result.originality.score}%</div>
            <div class="score-label">Originality</div>
        </div>
    </div>

    <div class="ai-alert ${result.aiDetection.likelihood}">
        <strong>AI Detection: ${result.aiDetection.likelihood.toUpperCase()}</strong> (${result.aiDetection.confidence}% confidence)<br>
        ${result.aiDetection.reasoning}
    </div>

    <div class="section">
        <h3>üìã Overall Assessment</h3>
        <p>${result.overallFeedback}</p>
    </div>

    <div class="section">
        <h3>‚úÖ Strengths</h3>
        <ul>${(result.strengths || []).map(s => `<li>${s}</li>`).join('')}</ul>
    </div>

    <div class="section">
        <h3>üéØ Areas to Improve</h3>
        <ul>${(result.improvements || []).map(s => `<li>${s}</li>`).join('')}</ul>
    </div>

    <div class="section">
        <h3>üìÑ Marked Essay</h3>
        <div class="essay-box">${highlightedEssay}</div>
    </div>
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Essay_Report_${studentName.replace(/\s+/g, '_')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Copy essay text
        function copyEssayText(cardId) {
            const essayContainer = document.getElementById(`${cardId}-essay`);
            if (essayContainer) {
                const text = essayContainer.innerText;
                navigator.clipboard.writeText(text).then(() => {
                    alert('Essay text copied to clipboard!');
                });
            }
        }

        // Update class summary statistics
        function updateClassSummary() {
            const validResults = batchResults.filter(r => !r.error);

            if (validResults.length === 0) {
                document.getElementById('summaryTotal').textContent = '0';
                return;
            }

            const avgGrammar = Math.round(validResults.reduce((sum, r) => sum + r.result.grammar.score, 0) / validResults.length);
            const avgSpelling = Math.round(validResults.reduce((sum, r) => sum + r.result.spelling.score, 0) / validResults.length);
            const avgOriginality = Math.round(validResults.reduce((sum, r) => sum + r.result.originality.score, 0) / validResults.length);
            const aiFlags = validResults.filter(r => r.result.aiDetection.likelihood !== 'low').length;

            document.getElementById('summaryTotal').textContent = validResults.length;
            document.getElementById('summaryAvgGrammar').textContent = `${avgGrammar}%`;
            document.getElementById('summaryAvgSpelling').textContent = `${avgSpelling}%`;
            document.getElementById('summaryAvgOriginality').textContent = `${avgOriginality}%`;
            document.getElementById('summaryAiFlags').textContent = aiFlags;
        }

        // Generate personalized practice for a student (optional - on demand)
        async function generatePractice(studentName, index) {
            if (!batchResults[index] || batchResults[index].error) {
                alert('No valid results for this student.');
                return;
            }

            const { result } = batchResults[index];
            const skillGaps = result.skillGaps;
            const gradeLevel = result.detectedGradeLevel?.level || 8;

            if (!skillGaps || !skillGaps.priority || skillGaps.priority.length === 0) {
                alert('No skill gaps identified for this student. Practice generation not needed.');
                return;
            }

            const apiKey = document.getElementById('apiKey').value.trim();
            const provider = document.getElementById('apiProvider').value;

            if (!apiKey) {
                alert('Please enter your API key first.');
                return;
            }

            // Show loading state
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Generating...';
            btn.disabled = true;

            try {
                const practicePrompt = `You are an expert English teacher creating personalized practice exercises.

STUDENT: ${studentName}
GRADE LEVEL: ${gradeLevel}th grade
PRIORITY SKILL GAPS: ${skillGaps.priority.join(', ')}

DETAILED SKILL GAPS:
${skillGaps.grammar?.length > 0 ? `Grammar Issues: ${skillGaps.grammar.map(g => g.skill).join(', ')}` : ''}
${skillGaps.mechanics?.length > 0 ? `Mechanics Issues: ${skillGaps.mechanics.map(m => m.skill).join(', ')}` : ''}
${skillGaps.organization?.length > 0 ? `Organization Issues: ${skillGaps.organization.map(o => o.skill).join(', ')}` : ''}
${skillGaps.development?.length > 0 ? `Development Issues: ${skillGaps.development.map(d => d.skill).join(', ')}` : ''}
${skillGaps.vocabulary?.length > 0 ? `Vocabulary Issues: ${skillGaps.vocabulary.map(v => v.skill).join(', ')}` : ''}

Create a personalized practice worksheet with 5-8 exercises targeting the TOP 2-3 priority skill gaps.

FORMAT YOUR RESPONSE AS A COMPLETE HTML DOCUMENT that can be printed or saved:
- Include a title with the student's name
- Brief explanation of what skills they're practicing and why
- Numbered exercises with clear instructions
- Mix of exercise types: fill-in-blank, identify errors, rewrite sentences, short writing prompts
- Include an answer key at the bottom (marked clearly)
- Use appropriate difficulty for ${gradeLevel}th grade

Return ONLY the HTML document, ready to print.`;

                let practiceHTML;

                if (provider === 'anthropic') {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 4000,
                            temperature: 0.7,
                            messages: [{ role: 'user', content: practicePrompt }]
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'API request failed');
                    }

                    const data = await response.json();
                    practiceHTML = data.content[0].text;
                } else {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o',
                            max_tokens: 4000,
                            temperature: 0.7,
                            messages: [{ role: 'user', content: practicePrompt }]
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'API request failed');
                    }

                    const data = await response.json();
                    practiceHTML = data.choices[0].message.content;
                }

                // Clean up the HTML if wrapped in code fences
                if (practiceHTML.startsWith('```')) {
                    practiceHTML = practiceHTML.replace(/^```html?\n?/, '').replace(/\n?```$/, '');
                }

                // Download the practice worksheet
                const blob = new Blob([practiceHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Practice_${studentName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                btn.innerHTML = '‚úÖ Downloaded!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Practice generation error:', error);
                alert('Error generating practice: ' + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Export grades in Schoology-compatible CSV format
        function exportSchoologyCSV() {
            const validResults = batchResults.filter(r => !r.error);

            if (validResults.length === 0) {
                alert('No results to export.');
                return;
            }

            // Schoology CSV format: Student Name, Score (or specific columns as needed)
            const headers = [
                'Student Name',
                'First Name',
                'Last Name',
                'Overall Score',
                'Grammar Score',
                'Spelling Score',
                'Originality Score',
                'Grade Level',
                'Essay Type',
                'AI Likelihood',
                'Word Count',
                'Priority Skill Gaps'
            ];

            const rows = validResults.map(r => {
                const { studentName, result } = r;
                const nameParts = studentName.split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';
                const wordCount = r.essayText ? r.essayText.split(/\s+/).length : 0;
                const priorityGaps = result.skillGaps?.priority?.join('; ') || '';

                return [
                    studentName,
                    firstName,
                    lastName,
                    result.finalScore || Math.round((result.grammar.score + result.spelling.score + result.originality.score) / 3),
                    result.grammar.score,
                    result.spelling.score,
                    result.originality.score,
                    result.detectedGradeLevel?.level || '',
                    result.detectedEssayType || '',
                    result.aiDetection.likelihood,
                    wordCount,
                    priorityGaps
                ];
            });

            // Build CSV
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => {
                    // Escape quotes and wrap in quotes if contains comma or newline
                    const str = String(cell);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                }).join(','))
            ].join('\n');

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Schoology_Grades_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Export full detailed report CSV
        function exportBatchResultsCSV() {
            const validResults = batchResults.filter(r => !r.error);

            if (validResults.length === 0) {
                alert('No results to export.');
                return;
            }

            const headers = [
                'Student Name',
                'Overall Score',
                'Grammar Score',
                'Spelling Score',
                'Originality Score',
                'Grade Level',
                'Essay Type',
                'Word Count',
                'AI Likelihood',
                'AI Red Flags',
                'Strengths',
                'Areas to Improve',
                'Grammar Issues',
                'Spelling Errors',
                'Priority Skill Gaps',
                'Overall Feedback'
            ];

            const rows = validResults.map(r => {
                const { studentName, result, essayText } = r;
                const wordCount = essayText ? essayText.split(/\s+/).length : 0;

                return [
                    studentName,
                    result.finalScore || Math.round((result.grammar.score + result.spelling.score + result.originality.score) / 3),
                    result.grammar.score,
                    result.spelling.score,
                    result.originality.score,
                    result.detectedGradeLevel?.level || '',
                    result.detectedEssayType || '',
                    wordCount,
                    result.aiDetection.likelihood,
                    (result.aiDetection.redFlags || []).join('; '),
                    (result.strengths || []).join('; '),
                    (result.improvements || []).join('; '),
                    (result.grammar.issues || []).map(i => `${i.error}: ${i.suggestion}`).join('; '),
                    (result.spelling.errors || []).map(e => `${e.word} ‚Üí ${e.correction}`).join('; '),
                    result.skillGaps?.priority?.join('; ') || '',
                    result.overallFeedback || ''
                ];
            });

            // Build CSV
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => {
                    const str = String(cell);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                }).join(','))
            ].join('\n');

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Essay_Grader_Full_Report_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
